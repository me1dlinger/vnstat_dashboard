<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>网络流量统计</title>
    <link
      href="data:image/x-icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAD//////////////////////////3I2JLdyNyTnczYjUAAAAAD///////////////////////////////////////////////////////////////9yNiPJdTgl/3g6Jv9yNyTKbzcnIAAAAACcpgBQnKYAiZ2lAJmepQBm////////////////AAAAAAAAAAAAAAAAcjcjdHY5Jf9yNiT/ci4m/3I1JPAAAAAAnqUARAAAAAAAAAAAnqcArZmqAA///////////wAAAAAAAAAAAAAAAHI3Ikp2NyX/dDwj/56nAP93RiH2AAAAAAAAAAAAAAAAAAAAAJ2mAG2dpgBT//////////8AAAAAAAAAAIFAKkNyNiP/bykm/5iaCf98VR//cDIk/gAAAAAAAAAAAAAAAAAAAACcpgCGoKYAK6BSO7agVDrMnlI5eZ5SOFGmVz3/hzwx/4uCEP97UR//cDEl/3Y5Jf8AAAAAAAAAAAAAAAAAAAAAnaYAnv////+hUzvppVY9/6ZXPf+nVz3/olE8/6J3Lf+PdB7/bS0k/3I3JP9zNyT/cjck72YzGQoAAAAAAAAAAJ6mAKD/////n1Q7UqlYPv+hVDv/oVM7/6FYOf+ekhj/pE4//4dELv9vNSL/cjck/3Q4Jf9yNiT3AAAAAJ6nAJ2bogAh/////wAAAACgVDrMpVY8/6JOPf+fjxv/oVI7/6FUO/+kVj3/h0Qu/281Iv9yNyT/dDgl/3I4JOmktgCVAAAAAP//////////nlI0IqFSPPOhaDL4oX8o/6dUP/+iVTv/oVQ7/6RWPf+GRC7/bzUi/3I3JP91OCX/bislpP////////////////////8AAAAAnK0ArQAAAAAAAAAAoVM78aNVPP+hVDv/pFY9/4ZDLv9zNiT/dTgl/3Y5Jf//////////////////////AAAAAJ2mAK4AAAAAAAAAAJZLLRGhVDr4o1U8/6FUO/+oWj3/pM4AYmwqIoR4Oib/cTYkh////////////////56oAGmepwBxAAAAAAAAAAAAAAAAmUwzFKFRO+ylVT3/pVY9/6RPPoeHQy7Fczck/3E2I7v///////////////+cpQCQnKgAQwAAAAAAAAAAAAAAAAAAAACdrQCPn2oxzahWPv+qWD7/qVg+/4lFL/9vNSHU////////////////nKYAap2lAIAAAAAAAAAAAKGoACacpgC/nqgAZgAAAACUUjEfoVQ6laFUO8OhVDv/oVQ7//////////////////////+dpgCvnqYApZ2nAKSdpgCa////////////////////////////////////////////////AYAAAAByAAA8PQAAPD8AADg9AAAwPAAAABwAAIAKAACAAgAAQAAAACwAAAAuEAAAPwAAAB8AAAAu4AAAAAAAAA=="
      rel="icon"
      type="image/x-icon"
    />
    <link
      rel="shortcut icon"
      href="data:image/x-icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAD//////////////////////////3I2JLdyNyTnczYjUAAAAAD///////////////////////////////////////////////////////////////9yNiPJdTgl/3g6Jv9yNyTKbzcnIAAAAACcpgBQnKYAiZ2lAJmepQBm////////////////AAAAAAAAAAAAAAAAcjcjdHY5Jf9yNiT/ci4m/3I1JPAAAAAAnqUARAAAAAAAAAAAnqcArZmqAA///////////wAAAAAAAAAAAAAAAHI3Ikp2NyX/dDwj/56nAP93RiH2AAAAAAAAAAAAAAAAAAAAAJ2mAG2dpgBT//////////8AAAAAAAAAAIFAKkNyNiP/bykm/5iaCf98VR//cDIk/gAAAAAAAAAAAAAAAAAAAACcpgCGoKYAK6BSO7agVDrMnlI5eZ5SOFGmVz3/hzwx/4uCEP97UR//cDEl/3Y5Jf8AAAAAAAAAAAAAAAAAAAAAnaYAnv////+hUzvppVY9/6ZXPf+nVz3/olE8/6J3Lf+PdB7/bS0k/3I3JP9zNyT/cjck72YzGQoAAAAAAAAAAJ6mAKD/////n1Q7UqlYPv+hVDv/oVM7/6FYOf+ekhj/pE4//4dELv9vNSL/cjck/3Q4Jf9yNiT3AAAAAJ6nAJ2bogAh/////wAAAACgVDrMpVY8/6JOPf+fjxv/oVI7/6FUO/+kVj3/h0Qu/281Iv9yNyT/dDgl/3I4JOmktgCVAAAAAP//////////nlI0IqFSPPOhaDL4oX8o/6dUP/+iVTv/oVQ7/6RWPf+GRC7/bzUi/3I3JP91OCX/bislpP////////////////////8AAAAAnK0ArQAAAAAAAAAAoVM78aNVPP+hVDv/pFY9/4ZDLv9zNiT/dTgl/3Y5Jf//////////////////////AAAAAJ2mAK4AAAAAAAAAAJZLLRGhVDr4o1U8/6FUO/+oWj3/pM4AYmwqIoR4Oib/cTYkh////////////////56oAGmepwBxAAAAAAAAAAAAAAAAmUwzFKFRO+ylVT3/pVY9/6RPPoeHQy7Fczck/3E2I7v///////////////+cpQCQnKgAQwAAAAAAAAAAAAAAAAAAAACdrQCPn2oxzahWPv+qWD7/qVg+/4lFL/9vNSHU////////////////nKYAap2lAIAAAAAAAAAAAKGoACacpgC/nqgAZgAAAACUUjEfoVQ6laFUO8OhVDv/oVQ7//////////////////////+dpgCvnqYApZ2nAKSdpgCa////////////////////////////////////////////////AYAAAAByAAA8PQAAPD8AADg9AAAwPAAAABwAAIAKAACAAgAAQAAAACwAAAAuEAAAPwAAAB8AAAAu4AAAAAAAAA=="
      type="image/x-icon"
    />
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        padding: 20px;
        color: black;
      }
      /* 添加登录界面样式 */
      .login-container {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        background: #f0f2f5;
      }

      .login-box {
        background: white;
        padding: 2rem;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        width: 400px;
      }

      .form-group {
        margin-bottom: 1.5rem;
      }

      .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        color: #666;
      }

      .form-group input {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid #ddd;
        border-radius: 4px;
      }

      .error-message {
        color: #ff4444;
        margin-top: 1rem;
      }
      .grid {
        display: grid;
        grid-template-columns: repeat(4, minmax(250px, 1fr));
        gap: var(--gap-size);
        padding: 0 var(--gap-size);
        width: calc(100% - 2 * var(--gap-size));
        margin: 0 auto;
      }

      /* 添加容器样式 */
      .stat-container {
        display: flex;
        justify-content: space-between;
        padding: 0 10%;
        /* 两侧间距 */
        margin: 20px 0;
      }

      .stat-card {
        background: #000000;
        border: 5px solid #cd6d27;
        border-radius: 30px;
        padding: 25px;
        color: white;
        position: relative;
        min-height: 150px;
        box-shadow: 0 4px 8px rgba(205, 109, 39, 0.2);
        box-sizing: border-box;
        width: 18%;
        min-width: 220px;
        margin: 0 1%;
        flex-shrink: 0;
      }

      /* 响应式处理 */
      @media (max-width: 1200px) {
        .stat-container {
          flex-wrap: wrap;
          justify-content: flex-start;
        }

        .stat-card {
          width: 48%;
          margin: 1%;
        }
      }

      .stat-label {
        position: absolute;
        bottom: -35px;
        left: 50%;
        transform: translateX(-50%);
        background: #cd6d27;
        color: white;
        padding: 6px 25px;
        border-radius: 0 0 4px 4px;
        font-size: 0.9em;
        text-align: center;
        white-space: nowrap;
        z-index: 1;
      }

      .stat-row {
        display: flex;
        align-items: center;
        /* margin: 15px 0; */
        padding: 8px;
        border-bottom: 1px solid #333;
      }

      .stat-icon {
        font-size: 1.4em;
        margin-right: 15px;
        width: 30px;
        text-align: center;
      }

      .stat-value {
        font-size: 1.8em;
        font-weight: 500;
        position: relative;
      }

      .stat-unit {
        font-size: 0.6em;
        vertical-align: super;
        margin-left: 3px;
        color: #cd6d27;
      }

      .control-bar {
        display: flex;
        gap: 15px;
        background: #000;
        border-radius: 8px;
        margin: 44px 0;
        align-items: center;
        flex-wrap: wrap;
        justify-content: space-between;
        align-items: center;
        padding: 13px 30px;
      }

      .control-group {
        display: flex;
        align-items: center;
        gap: 15px;
        flex: 1;
      }

      .left {
        justify-content: flex-start;
      }

      .center {
        justify-content: center;
      }

      .right {
        justify-content: flex-end;
      }

      .date-range {
        margin: 0 20px;

        color: white;
      }

      /* 响应式处理 */
      @media (max-width: 768px) {
        .control-bar {
          flex-wrap: wrap;
          gap: 15px;
        }

        .control-group {
          flex: 0 0 100%;
          justify-content: center !important;
        }
      }
      select {
        background: #cd6d27;
        color: white;
        border: 1px solid #cd6d27;
        padding: 8px 15px;
        border-radius: 4px;
      }

      button {
        background: #000;
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 4px;
        cursor: pointer;
        transition: opacity 0.3s;
      }

      .time-display {
        font-size: 0.9em;
        line-height: 1.4;
      }

      .time-row {
        display: flex;
        gap: 8px;
        align-items: center;
      }

      .time-label {
        color: white;
        white-space: nowrap;
      }

      .time-value {
        color: white;
        font-weight: 500;
      }

      .traffic-summary {
        display: flex;
        justify-content: center;
        gap: 2rem;
        margin: -1rem 0;
        font-size: 1.1rem;
      }

      .summary-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        border-radius: 6px;
      }

      .summary-item i {
        font-size: 1.2rem;
      }

      button:hover {
        opacity: 0.9;
      }

      .view-switcher {
        position: relative;
        margin-bottom: 1rem;
        margin-top: -40px;
      }

      .switch-container {
        display: flex;
        /* position: absolute; */
        top: 10px;
        right: 10px;
        z-index: 10;
        display: flex;
        gap: 8px;
      }

      .switch-container button {
        background: none;
        border: 1px solid #e4e4e7;
        border-radius: 6px;
        padding: 8px;
        cursor: pointer;
        opacity: 0.6;
        transition: all 0.2s;
      }

      .switch-container button.active {
        opacity: 1;
        border-color: #3b82f6;
        color: #3b82f6;
      }

      /* 移除全局button样式，改为指定类名 */
      .view-switch {
        background: white !important;
        /* 强制白色背景 */
        color: #333 !important;
        /* 深色文字 */
        border: 1px solid #e4e4e7 !important;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        transition: all 0.2s;
      }

      .view-switch.active {
        border-color: #3b82f6 !important;
        color: #3b82f6 !important;
        box-shadow: 0 2px 6px rgba(59, 130, 246, 0.2);
      }

      .data-table {
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        overflow: hidden;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9em;
      }

      th {
        background: #f8fafc;
        padding: 12px 16px;
        text-align: left;
        font-weight: 600;
        border-bottom: 2px solid #e5e7eb;
        cursor: pointer;
        user-select: none;
        transition: background 0.2s;
      }
      th:hover {
        background: #f1f5f9;
      }
      th i {
        margin-left: 8px;
        font-size: 0.8em;
        color: #64748b;
      }
      td {
        padding: 12px 16px;
        border-bottom: 1px solid #e5e7eb;
      }

      tr:nth-child(even) {
        background: #f8fafc;
      }
      /* API 设置按钮和弹窗样式 */
      .api-settings-button {
        font-size: 17px;
        position: fixed;
        top: 30px;
        right: 25px;
        background: #ffffff00;
        color: #e5ccaf;
        border: none;
        border-radius: 4px;
        padding: 8px 15px;
        cursor: pointer;
        z-index: 1000;
      }
      .api-settings-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 2000;
      }

      .api-settings-content {
        background: white;
        border-radius: 8px;
        padding: 20px;
        width: 400px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      }

      .api-settings-content h3 {
        margin-top: 0;
        margin-bottom: 20px;
        color: #333;
      }

      .api-input {
        width: 100%;
        padding: 10px;
        margin-bottom: 15px;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-sizing: border-box;
      }

      .api-settings-buttons {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
      }

      .api-settings-buttons button {
        padding: 8px 15px;
        cursor: pointer;
      }

      .save-button {
        background: #cd6d27;
        color: white;
      }

      .cancel-button {
        background: #f0f0f0;
        color: #333;
      }
    </style>
  </head>

  <body>
    <div id="app">
      <button class="api-settings-button" @click="showApiSettings">
        <i class="fas fa-cog"></i>
      </button>
      <div class="api-settings-modal" v-if="apiSettingsVisible">
        <div class="api-settings-content">
          <h3>页面配置</h3>
          <label class="switch-label">API 接口设置：</label>
          <input
            type="text"
            class="api-input"
            v-model="assistApi"
            placeholder="请输入API地址"
          />
          <!-- 新增备份数据开关 -->
          <div>
            <label>启用备份数据：</label>
            <label class="switch">
              <input type="checkbox" v-model="enableBackupData" />
              <span class="slider round"></span>
            </label>
          </div>

          <div class="api-settings-buttons">
            <button class="cancel-button" @click="cancelApiSettings">
              取消
            </button>
            <button class="save-button" @click="saveApiSettings">保存</button>
          </div>
        </div>
      </div>
      <!-- 登录界面 -->
      <div v-if="!isAuthenticated" class="login-container">
        <div class="login-box">
          <h2>网络流量统计系统</h2>
          <form @submit.prevent="handleLogin">
            <div class="form-group">
              <label><i class="fas fa-user"></i> 用户名</label>
              <input type="text" v-model="loginForm.username" required />
            </div>
            <div class="form-group">
              <label><i class="fas fa-lock"></i> 密码</label>
              <input type="password" v-model="loginForm.password" required />
            </div>
            <button type="submit" :disabled="loggingIn">
              {{ loggingIn ? '登录中...' : '登录' }}
            </button>
            <div v-if="loginError" class="error-message">{{ loginError }}</div>
          </form>
        </div>
      </div>
      <div v-else>
        <!-- 统计卡片 -->
        <div class="stat-container" v-if="currentInterface">
          <!-- 总统计 -->
          <div class="stat-card">
            <div class="stat-row">
              <i class="fas fa-tachometer-alt stat-icon"></i>
              <div class="stat-value">
                {{ formatSum(currentInterface.traffic.total).value }}
                <span class="stat-unit"
                  >{{ formatSum(currentInterface.traffic.total).unit }}</span
                >
              </div>
            </div>
            <div class="stat-row">
              <i class="fas fa-arrow-down stat-icon"></i>
              <div class="stat-value">
                {{ formatBytes(currentInterface.traffic.total.rx).value }}
                <span class="stat-unit"
                  >{{ formatBytes(currentInterface.traffic.total.rx).unit
                  }}</span
                >
              </div>
            </div>
            <div class="stat-row">
              <i class="fas fa-arrow-up stat-icon"></i>
              <div class="stat-value">
                {{ formatBytes(currentInterface.traffic.total.tx).value }}
                <span class="stat-unit"
                  >{{ formatBytes(currentInterface.traffic.total.tx).unit
                  }}</span
                >
              </div>
            </div>
            <div class="stat-label">总计</div>
          </div>
          <div
            class="stat-card"
            v-for="(data, title) in summaryData"
            :key="title"
          >
            <div class="stat-row">
              <i class="fas fa-chart-bar stat-icon"></i>
              <div class="stat-value">
                {{ formatSum(data).value }}
                <span class="stat-unit">{{ formatSum(data).unit }}</span>
              </div>
            </div>
            <div class="stat-row">
              <i class="fas fa-arrow-down stat-icon"></i>
              <div class="stat-value">
                {{ formatBytes(data.rx).value }}
                <span class="stat-unit">{{ formatBytes(data.rx).unit }}</span>
              </div>
            </div>
            <div class="stat-row">
              <i class="fas fa-arrow-up stat-icon"></i>
              <div class="stat-value">
                {{ formatBytes(data.tx).value }}
                <span class="stat-unit">{{ formatBytes(data.tx).unit }}</span>
              </div>
            </div>
            <div class="stat-label">{{ title.toUpperCase() }}</div>
          </div>
        </div>

        <!-- 修改后的控制条结构 -->
        <div class="control-bar">
          <!-- 左侧控件 -->
          <div class="control-group left" v-show="!interfacesDataMode">
            <select v-model="timeRangeType">
              <option value="hour">按时</option>
              <option value="day">按日</option>
              <option value="month">按月</option>
              <option value="year">按年</option>
            </select>
          </div>
          <div class="control-group center" v-show="!interfacesDataMode">
            <button @click="adjustTime(-1)">
              <i class="fas fa-chevron-left"></i>
            </button>
            <span class="date-range">{{ dateRange }}</span>
            <button
              :style="{ visibility: showNextButton ? 'visible' : 'hidden' }"
              @click="adjustTime(1)"
            >
              <i class="fas fa-chevron-right"></i>
            </button>
          </div>

          <!-- 右侧网卡选择 -->
          <div class="control-group right">
            <div class="time-display" v-if="latestSelectedInterfaceData">
              <div class="time-row">
                <span class="time-label">统计开始：</span>
                <span class="time-value"
                  >{{ formatTime(latestSelectedInterfaceData.created) }}</span
                >
              </div>
              <div class="time-row">
                <span class="time-label">最后更新：</span>
                <span class="time-value"
                  >{{ formatTime(latestSelectedInterfaceData.updated) }}</span
                >
              </div>
            </div>
            <select
              v-model="latestSelectedInterfaceData"
              v-show="!interfacesDataMode"
            >
              <option v-for="iface in latestInterfacesData" :value="iface">
                {{ iface.name }}
              </option>
            </select>
            <button title="按网卡统计" @click="handleShowInterfaceData()">
              <i class="fas fa-network-wired"></i>
            </button>
          </div>
        </div>
        <div v-show="!interfacesDataMode">
          <div class="traffic-summary">
            <div class="summary-item" title="上行流量">
              <i class="fas fa-upload text-blue-500"></i>
              <span>{{ uploadGB }}</span>
            </div>
            <div class="summary-item" title="总流量">
              <i class="fas fa-exchange-alt text-purple-500"></i>
              <span>{{ totalGB }}</span>
            </div>
            <div class="summary-item" title="下行流量">
              <i class="fas fa-download text-green-500"></i>
              <span>{{ downloadGB }}</span>
            </div>
          </div>
          <!-- 在图表容器上方添加 -->
          <div class="view-switcher right">
            <div class="switch-container">
              <button
                @click="currentView = 'chart'"
                class="view-switch"
                :class="{active: currentView === 'chart'} "
                title="图表视图"
              >
                <i class="fas fa-chart-line"></i>
              </button>
              <button
                @click="currentView = 'table'"
                class="view-switch"
                :class="{active: currentView === 'table'}"
                title="表格视图"
              >
                <i class="fas fa-table"></i>
              </button>
            </div>
          </div>
          <!-- 图表容器 -->
          <div class="chart-container">
            <div v-show="currentView === 'chart'" id="trafficChart"></div>
            <div v-show="currentView === 'table'" class="data-table">
              <table>
                <thead>
                  <tr>
                    <th @click="sortTable('timestamp')">
                      日期/时间
                      <i class="fas" :class="sortIcon('timestamp')"></i>
                    </th>
                    <th @click="sortTable('tx')">
                      上行
                      <i class="fas" :class="sortIcon('tx')"></i>
                    </th>
                    <th @click="sortTable('rx')">
                      下行
                      <i class="fas" :class="sortIcon('rx')"></i>
                    </th>
                    <th>总计</th>
                  </tr>
                </thead>
                <tbody>
                  <tr v-for="item in sortedTableData" :key="item.timestamp">
                    <td>{{ getformatTableTime(item.date,item.time) }}</td>
                    <td>
                      {{ formatBytes(item.tx).value+formatBytes(item.tx).unit }}
                    </td>
                    <td>
                      {{ formatBytes(item.rx).value +formatBytes(item.rx).unit}}
                    </td>
                    <td>
                      {{ formatBytes(item.tx +
                      item.rx).value+formatBytes(item.tx + item.rx).unit }}
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
        <!-- 网卡统计表格 -->
        <div v-show="interfacesDataMode" class="data-table">
          <table>
            <thead>
              <tr>
                <th @click="sortTable('name')">
                  网卡名称
                  <i class="fas" :class="sortIcon('name')"></i>
                </th>
                <th @click="sortTable('todayRx')">
                  今日下行
                  <i class="fas" :class="sortIcon('todayRx')"></i>
                </th>
                <th @click="sortTable('todayTx')">
                  今日上行
                  <i class="fas" :class="sortIcon('todayTx')"></i>
                </th>
                <th @click="sortTable('todayTotal')">
                  今日总计
                  <i class="fas" :class="sortIcon('todayTotal')"></i>
                </th>
                <th @click="sortTable('totalRx')">
                  全部下行
                  <i class="fas" :class="sortIcon('totalRx')"></i>
                </th>
                <th @click="sortTable('totalTx')">
                  全部上行
                  <i class="fas" :class="sortIcon('totalTx')"></i>
                </th>
                <th @click="sortTable('totalTotal')">
                  全部总计
                  <i class="fas" :class="sortIcon('totalTotal')"></i>
                </th>
              </tr>
            </thead>
            <tbody>
              <tr v-for="item in sortedInterfaces" :key="item.name">
                <td>{{ item.name }}</td>
                <td>
                  {{ formatBytes(item.todayRx).value }}{{
                  formatBytes(item.todayRx).unit }}
                </td>
                <td>
                  {{ formatBytes(item.todayTx).value }}{{
                  formatBytes(item.todayTx).unit }}
                </td>
                <td>
                  {{ formatBytes(item.todayTotal).value }}{{
                  formatBytes(item.todayTotal).unit }}
                </td>
                <td>
                  {{ formatBytes(item.totalRx).value }}{{
                  formatBytes(item.totalRx).unit }}
                </td>
                <td>
                  {{ formatBytes(item.totalTx).value }}{{
                  formatBytes(item.totalTx).unit }}
                </td>
                <td>
                  {{ formatBytes(item.totalTotal).value }}{{
                  formatBytes(item.totalTotal).unit }}
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <script>
      new Vue({
        el: "#app",
        data: {
          // 认证相关数据
          isAuthenticated: true,
          loginForm: { username: "", password: "" },
          loggingIn: false,
          loginError: "",
          authToken: null,
          latestRawData: {},
          latestInterfacesTableData: [],
          latestInterfacesData: [],
          latestSelectedInterfaceData: null,
          chart: null,
          timeRangeType: "day",
          currentRange: new Date(),
          currentStats: {},
          currentView: "chart",
          filteredData: [],
          filteredTableData: [],
          interfacesDataMode: false,
          showNextButton: false,
          sortKey: "name",
          sortOrder: "asc",
          defaultInterface: "enp3s0",
          apiSettingsVisible: false,
          assistApi: null,
          url: {},
          // 备份数据启用
          enableBackupData: null,
          // 内存缓存 {dateStr: data}
          backupCache: {},
          //维护键顺序
          cacheKeys: [],
          pendingBackups: new Set(),
        },
        computed: {
          uploadGB() {
            return (
              this.formatBytes(this.currentStats.tx).value +
              this.formatBytes(this.currentStats.tx).unit
            );
          },
          downloadGB() {
            return (
              this.formatBytes(this.currentStats.rx).value +
              this.formatBytes(this.currentStats.rx).unit
            );
          },
          totalGB() {
            return (
              this.formatBytes(this.currentStats.total).value +
              this.formatBytes(this.currentStats.total).unit
            );
          },
          currentInterface() {
            return (
              this.latestSelectedInterfaceData || this.latestInterfacesData[0]
            );
          },
          summaryData() {
            const latestInterfacesData =
              this.latestSelectedInterfaceData || this.latestInterfacesData[0];
            return {
              本月: this.getMonthData(latestInterfacesData),
              今日: this.getDayData(latestInterfacesData),
              昨日: this.getYesterdayData(latestInterfacesData),
            };
          },
          sortedInterfaces() {
            return [...this.latestInterfacesTableData].sort((a, b) => {
              let modifier = -1;
              if (this.sortOrder === "asc") modifier = 1;
              if (a[this.sortKey] < b[this.sortKey]) return -1 * modifier;
              if (a[this.sortKey] > b[this.sortKey]) return 1 * modifier;
              return 0;
            });
          },
          sortedTableData() {
            return [...this.filteredTableData].sort((a, b) => {
              let modifier = -1;
              if (this.sortOrder === "asc") modifier = 1;
              if (a[this.sortKey] < b[this.sortKey]) return -1 * modifier;
              if (a[this.sortKey] > b[this.sortKey]) return 1 * modifier;
              return 0;
            });
          },
          dateRange() {
            const d = new Date(this.currentRange);
            const format = (date, withDay = true, withTime = false) => {
              let result = `${date.getFullYear()}-${String(
                date.getMonth() + 1
              ).padStart(2, "0")}${
                withDay ? `-${String(date.getDate()).padStart(2, "0")}` : ""
              }`;
              if (withTime) {
                result += ` ${String(date.getHours()).padStart(2, "0")}:00`;
              }
              return result;
            };
            switch (this.timeRangeType) {
              case "hour":
                const hourStart = new Date(d);
                hourStart.setMinutes(0, 0, 0);
                const hourEnd = new Date(hourStart);
                hourEnd.setHours(hourStart.getHours() + 1);
                return `${format(hourStart, true, true)} - ${format(
                  hourEnd,
                  true,
                  true
                )}`;
              case "day":
                const day = new Date(d);
                return `${format(day)}`;
              case "month":
                const start = new Date(d.getFullYear(), d.getMonth(), 1);
                const end = new Date(d.getFullYear(), d.getMonth() + 1, 0);
                return `${format(start)} - ${format(end)}`;
              case "year":
                return `${d.getFullYear()}年`;
            }
          },
        },
        watch: {
          timeRangeType() {
            this.showNextButton = false;
            (this.currentRange = new Date()), this.updateChart();
          },
          currentDate() {
            this.updateChart();
          },
          latestSelectedInterfaceData() {
            this.updateChart();
          },
        },
        methods: {
          // 登录逻辑
          async handleLogin() {
            if (!this.assistApi) {
              alert("请先点击右上角设置统一API入口");
              return;
            }
            this.loggingIn = true;
            this.loginError = "";
            try {
              const response = await fetch(this.url.login, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(this.loginForm),
              });
              if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || "登录失败");
              }
              const { token } = await response.json();
              this.handleAuthSuccess(token);
            } catch (err) {
              this.loginError = err.message || "登录请求失败";
            } finally {
              this.loggingIn = false;
            }
          },
          // 认证成功处理
          handleAuthSuccess(token) {
            // 存储Token
            localStorage.setItem("jwt_token", token);
            this.authToken = token;
            this.isAuthenticated = true;
            // 加载数据
            this.loadData();
          },
          // 注销处理
          handleLogout() {
            localStorage.removeItem("jwt_token");
            this.isAuthenticated = false;
            this.authToken = null;
          },
          async loadData() {
            const response = await this.fetchWithAuth(this.url.loadJson);
            this.latestRawData = await response.json();
            this.latestInterfacesData = this.latestRawData.interfaces;
            if (this.latestInterfacesData.length > 0) {
              const defaultInterface = this.latestInterfacesData.find(
                (intf) => intf.name === this.defaultInterface
              );
              this.latestSelectedInterfaceData =
                defaultInterface || this.latestInterfacesData[0];
            }
            await this.$nextTick();
          },
          async fetchWithAuth(url, options = {}) {
            const response = await fetch(url, {
              ...options,
              headers: {
                Authorization: `Bearer ${this.authToken}`,
                ...options.headers,
              },
            });
            if (response.status === 401) {
              this.handleLogout();
            }
            return response;
          },
          formatBytes(bytes) {
            const units = ["B", "KB", "MB", "GB", "TB"];
            let i = 0;
            bytes = Number(bytes);
            while (bytes >= 1024 && i < units.length - 1) {
              bytes /= 1024;
              i++;
            }
            return {
              value: bytes.toFixed(2),
              unit: units[i],
            };
          },
          formatSum(data) {
            const total = data.rx + data.tx;
            return this.formatBytes(total);
          },
          getMonthData(interface) {
            const year = new Date().getFullYear();
            const month = new Date().getMonth() + 1;
            return (
              interface.traffic.month.find(
                (d) => d.date.year === year && d.date.month === month
              ) || { rx: 0, tx: 0 }
            );
          },
          getDayData(interface) {
            const year = new Date().getFullYear();
            const month = new Date().getMonth() + 1;
            const day = new Date().getDate();
            return (
              interface.traffic.day.find(
                (d) =>
                  d.date.year === year &&
                  d.date.month === month &&
                  d.date.day === day
              ) || { rx: 0, tx: 0 }
            );
          },
          getYesterdayData(interface) {
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(today.getDate() - 1);
            const year = yesterday.getFullYear();
            const month = yesterday.getMonth() + 1;
            const day = yesterday.getDate();
            return (
              interface.traffic.day.find(
                (d) =>
                  d.date.year === year &&
                  d.date.month === month &&
                  d.date.day === day
              ) || { rx: 0, tx: 0 }
            );
          },
          adjustTime(offset) {
            const d = new Date(this.currentRange);
            const now = new Date();
            let isLimitReached = false;
            // 保存原始日期（用于闰年处理）
            const originalDate = d.getDate();
            const originalMonth = d.getMonth();
            switch (this.timeRangeType) {
              case "hour":
                // 自动处理跨日/月/年
                d.setTime(d.getTime() + offset * 60 * 60 * 1000);
                // 精确比较到小时级别
                isLimitReached =
                  d.getFullYear() === now.getFullYear() &&
                  d.getMonth() === now.getMonth() &&
                  d.getDate() === now.getDate() &&
                  d.getHours() === now.getHours();
                break;
              case "day":
                d.setDate(d.getDate() + offset);
                // 比较日期部分
                isLimitReached = this.isSameDay(d, now);
                break;
              case "month":
                // 先设置为当月第一天，避免跨月时的日期溢出问题
                d.setDate(1);
                d.setMonth(d.getMonth() + offset);
                // 处理跨月调整后的日期有效性（如1月31日→2月28/29日）
                const maxDays = new Date(
                  d.getFullYear(),
                  d.getMonth() + 1,
                  0
                ).getDate();
                d.setDate(Math.min(originalDate, maxDays));
                isLimitReached =
                  d.getFullYear() === now.getFullYear() &&
                  d.getMonth() === now.getMonth();
                break;
              case "year":
                const targetYear = d.getFullYear() + offset;
                d.setFullYear(targetYear);
                // 处理闰年2月29日的情况
                if (originalMonth === 1 && originalDate === 29) {
                  const isLeapYear = (year) =>
                    (year % 4 === 0 && year % 100 !== 0) || year % 400 === 0;
                  if (!isLeapYear(targetYear)) {
                    d.setMonth(1); // February
                    d.setDate(28);
                  }
                }
                isLimitReached = d.getFullYear() === now.getFullYear();
                break;
            }
            this.showNextButton = !isLimitReached;
            this.currentRange = d;
            this.updateChart();
          },
          //比较两个日期是否是同一天
          isSameDay(date1, date2) {
            return (
              date1.getFullYear() === date2.getFullYear() &&
              date1.getMonth() === date2.getMonth() &&
              date1.getDate() === date2.getDate()
            );
          },
          showApiSettings() {
            this.apiSettingsVisible = !this.apiSettingsVisible;
          },
          saveApiSettings() {
            this.assistApi = this.normalizeUrl(this.assistApi);
            localStorage.setItem("assist_api", this.assistApi);
            localStorage.setItem("enable_backup", this.enableBackupData);
            if (!this.enableBackupData) {
              localStorage.removeItem("backup_data");
            }
            this.apiSettingsVisible = false;
            if (this.isAuthenticated) {
              this.loadData();
            }
          },
          normalizeUrl(url) {
            const trimmedUrl = url.trim();
            if (/^\/\//.test(trimmedUrl)) {
              return `http:${trimmedUrl}`;
            }
            if (!/^https?:\/\//i.test(trimmedUrl)) {
              return `http://${trimmedUrl}`;
            }
            return trimmedUrl;
          },
          cancelApiSettings() {
            this.apiSettingsVisible = false;
          },
          handleShowInterfaceData() {
            if (this.interfacesDataMode) {
              this.interfacesDataMode = false;
              this.updateChart();
            } else {
              this.interfacesDataMode = true;
              this.handleLatestInterfacesData();
            }
          },
          sortTable(key) {
            if (this.sortKey === key) {
              this.sortOrder = this.sortOrder === "asc" ? "desc" : "asc";
            } else {
              this.sortKey = key;
              this.sortOrder = "desc";
            }
          },
          sortIcon(key) {
            if (this.sortKey !== key) return "fa-sort";
            return this.sortOrder === "asc" ? "fa-sort-up" : "fa-sort-down";
          },
          handleLatestInterfacesData() {
            this.latestInterfacesTableData = this.latestInterfacesData.map(
              (item) => {
                const todayData = this.getDayData(item);
                return {
                  name: item.name,
                  todayRx: todayData.rx,
                  todayTx: todayData.tx,
                  todayTotal: todayData.rx + todayData.tx,
                  totalRx: item.traffic.total.rx,
                  totalTx: item.traffic.total.tx,
                  totalTotal: item.traffic.total.rx + item.traffic.total.tx,
                };
              }
            );
          },
          getMergedSeriesData() {
            const dataType = {
              hour: "fiveminute",
              day: "hour",
              month: "day",
              year: "month",
            }[this.timeRangeType];
            const currentDate = new Date(this.currentRange);
            const isPastDate = this.isPastDate(currentDate);
            // 判断是否需要使用备份数据
            let useBackup =
              this.enableBackupData &&
              isPastDate &&
              (this.timeRangeType === "hour" || this.timeRangeType === "day");
            if (useBackup) {
              const dateStr = this.getDateString(currentDate);
              this.getBackupData(dateStr).then((backupData) => {
                if (backupData) {
                  return this.processBackupData(
                    currentDate,
                    backupData,
                    dataType
                  );
                }
              });
            }
            //原有处理逻辑
            const latestRawData =
              this.latestSelectedInterfaceData.traffic[dataType];
            return this.processData(currentDate, latestRawData, dataType);
          },
          //判断是否是过去日期，保险起见昨天之前的数据都从备份中获取
          isPastDate(date) {
            const now = new Date();
            const compareDate = new Date(date);
            compareDate.setHours(23, 59, 59, 999);
            return compareDate < now;
          },
          //获取日期字符串
          getDateString(date) {
            return [
              date.getFullYear(),
              String(date.getMonth() + 1).padStart(2, "0"),
              String(date.getDate()).padStart(2, "0"),
            ].join("");
          },
          processData(currentDate, rawData, dataType) {
            let totalRx = 0,
              totalTx = 0;
            const rangeYear = currentDate.getFullYear();
            const rangeMonth = currentDate.getMonth() + 1;
            const rangeDay = currentDate.getDate();
            const rangeHour = currentDate.getHours();
            this.filteredData = rawData.filter((item) => {
              let match = false;
              switch (this.timeRangeType) {
                case "hour":
                  var itemYear = item.date.year;
                  var itemMonth = item.date.month;
                  var itemDay = item.date.day;
                  var itemHour = item.time ? item.time.hour : 0;
                  match =
                    itemYear === rangeYear &&
                    itemMonth === rangeMonth &&
                    itemDay === rangeDay &&
                    itemHour === rangeHour;
                  break;
                case "day":
                  var itemYear = item.date.year;
                  var itemMonth = item.date.month;
                  var itemDay = item.date.day;
                  match =
                    itemYear === rangeYear &&
                    itemMonth === rangeMonth &&
                    itemDay === rangeDay;
                  break;
                case "month":
                  var itemYear = item.date.year;
                  var itemMonth = item.date.month;
                  var itemDay = item.date.day;
                  match = itemYear === rangeYear && itemMonth === rangeMonth;
                  break;
                case "year":
                  var itemYear = item.date.year;
                  match = itemYear === rangeYear;
                  break;
              }
              if (match) {
                totalRx += item.rx || 0;
                totalTx += item.tx || 0;
              }
              return match;
            });
            this.currentStats = {
              rx: totalRx,
              tx: totalTx,
              total: totalRx + totalTx,
            };
            this.filteredTableData = this.filteredData;
            const getXValue = (date, time) =>
              this.getXValue(date, time, dataType);
            return [
              this.generateSeries("上行", "tx", "#E0C3A1", getXValue),
              this.generateSeries("下行", "rx", "#E37563", getXValue),
            ];
          },
          processCurrentData(currentDate, dataType) {},
          //获取备份数据（带缓存）
          async getBackupData(dateStr) {
            // 初始化 backupCache 为 Map（若尚未初始化）
            if (!(this.backupCache instanceof Map)) {
              this.backupCache = new Map();
            }
            //先检查内存缓存
            if (this.backupCache[dateStr]) {
              return this.backupCache[dateStr];
            }
            //再检查localStorage
            const cachedData = localStorage.getItem(`backup_data`);
            if (cachedData) {
              this.backupCache = JSON.parse(cachedData);
              if (this.backupCache[dateStr]) {
                return this.backupCache[dateStr];
              }
            }
            try {
              const url = `${this.url.backups}${dateStr}`;
              const response = await this.fetchWithAuth(url);
              const data = await response.json();
              // 插入新数据
              this.backupCache[dateStr] = data;
              this.cacheKeys.push(dateStr);
              // 如果长度超过5，删除最旧的键
              if (this.cacheKeys.length > 5) {
                const oldestKey = this.cacheKeys.shift();
                delete this.backupCache[oldestKey];
              }
              localStorage.setItem(
                `backup_data`,
                JSON.stringify(this.backupCache)
              );
              return data;
            } catch (e) {
              console.error("备份数据获取失败:", e);
              return null;
            }
          },
          //处理备份数据
          processBackupData(currentDate, backupData, dataType) {
            const selectedInterfaceData = backupData.interfaces.find(
              (item) => item.name === this.latestSelectedInterfaceData.name
            );
            // 筛选逻辑（示例处理小时粒度）
            const rawData = selectedInterfaceData.traffic[dataType];
            return this.processData(currentDate, rawData, dataType);
          },
          generateSeries(name, field, color, getX) {
            return {
              name,
              data: this.filteredData.map((d) => ({
                x: getX(d.date, d.time),
                y: d[field] / (1024 * 1024), // 统一单位转换
              })),
              color,
            };
          },
          getXValue(date, time, dataKey) {
            const itemYear = date.year;
            const itemMonth = String(date.month).padStart(2, "0");
            const itemDay = String(date.day).padStart(2, "0");
            var itemHour = "";
            var itemMinute = "";
            if (time) {
              itemHour = String(time.hour).padStart(2, "0");
              itemMinute = String(time.minute).padStart(2, "0");
            }
            switch (dataKey) {
              case "fiveminute":
                return `${itemYear}-${itemMonth}-${itemDay} ${itemHour}:${itemMinute}`;
              case "hour":
                return `${itemYear}-${itemMonth}-${itemDay} ${itemHour}时`;
              case "day":
                return `${itemYear}-${itemMonth}-${itemDay}`;
              case "month":
                return `${itemYear}-${itemMonth}`;
            }
          },
          updateChart() {
            const options = {
              chart: { type: "area", height: 400 },
              series: this.getMergedSeriesData(),
              fill: {
                type: "solid",
              },
              dataLabels: {
                enabled: false,
              },
              stroke: {
                curve: "smooth",
                width: 2,
              },
              markers: {
                size: 3,
                hover: { size: 5 },
              },
              xaxis: {
                type: "category",
                title: { text: this.getXAxisTitle() },
              },
              yaxis: {
                title: { text: "流量 (MB)" },
                labels: {
                  formatter: function (value) {
                    return value % 1 === 0
                      ? value.toFixed(0) // 整数显示
                      : value.toFixed(2); // 小数保留两位
                  },
                },
              },
              tooltip: {
                y: {
                  formatter: (value) => {
                    const formatResult = this.formatFromMB(value);
                    return formatResult.value + formatResult.unit;
                  },
                },
              },
            };
            if (this.chart) {
              this.chart.updateOptions(options);
            } else {
              this.chart = new ApexCharts(
                document.querySelector("#trafficChart"),
                options
              );
              this.chart.render();
            }
          },
          formatFromMB(mb) {
            const units = ["MB", "GB", "TB"];
            let value = Number(mb);
            let i = 0;
            while (value >= 1024 && i < units.length - 1) {
              value /= 1024;
              i++;
            }
            return {
              value: value.toFixed(2),
              unit: units[i],
            };
          },
          getformatTableTime(date, time) {
            const dataType = {
              hour: "fiveminute",
              day: "hour",
              month: "day",
              year: "month",
            }[this.timeRangeType];
            return this.getXValue(date, time, dataType);
          },
          getXAxisTitle() {
            return {
              day: "小时",
              month: "日期",
              year: "月份",
            }[this.timeRangeType];
          },
          formatTime(timeObj) {
            if (!timeObj?.timestamp) return "N/A";
            const date = this.getBeijingTime(timeObj.timestamp);
            return `${date.getUTCFullYear()}-${this.pad(
              date.getUTCMonth() + 1
            )}-${this.pad(date.getUTCDate())}
                ${this.pad(date.getUTCHours())}:${this.pad(
              date.getUTCMinutes()
            )}`;
          },
          // 补零函数
          pad(num) {
            return num.toString().padStart(2, "0");
          },
          getBeijingTime(timestamp) {
            const date = new Date(timestamp * 1000);
            date.setMinutes(date.getMinutes() + date.getTimezoneOffset() + 480); // UTC+8
            return date;
          },
        },
        async mounted() {
          // 初始化时检查本地Token
          const storedToken = localStorage.getItem("jwt_token");
          // 初始化检查缓存api选项
          const assistApi = localStorage.getItem("assist_api");
          const savedEnable = localStorage.getItem("enable_backup");
          this.enableBackupData =
            savedEnable !== null ? savedEnable === "true" : true;
          if (!this.enableBackupData) {
            localStorage.removeItem("backup_data");
          }
          if (assistApi) {
            this.assistApi = assistApi;
            this.url = {
              login: this.assistApi + "/auth/login",
              verify: this.assistApi + "/auth/verify",
              loadJson: this.assistApi + "/json.cgi",
              backups: this.assistApi + "/backups/",
            };
          }
          if (!this.assistApi) {
            alert("请先点击右上角设置统一API入口");
            this.handleLogout();
            return;
          }
          if (storedToken) {
            // 验证Token有效性
            this.authToken = storedToken;
            const response = await this.fetchWithAuth(this.url.verify);
            if (response.ok) {
              this.handleAuthSuccess(storedToken);
            } else {
              this.handleLogout();
            }
          } else {
            this.handleLogout();
          }
        },
      });
    </script>
  </body>
</html>
