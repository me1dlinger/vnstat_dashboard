<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>ç½‘ç»œæµé‡ç»Ÿè®¡</title>
    <link
      href="data:image/x-icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAD//////////////////////////3I2JLdyNyTnczYjUAAAAAD///////////////////////////////////////////////////////////////9yNiPJdTgl/3g6Jv9yNyTKbzcnIAAAAACcpgBQnKYAiZ2lAJmepQBm////////////////AAAAAAAAAAAAAAAAcjcjdHY5Jf9yNiT/ci4m/3I1JPAAAAAAnqUARAAAAAAAAAAAnqcArZmqAA///////////wAAAAAAAAAAAAAAAHI3Ikp2NyX/dDwj/56nAP93RiH2AAAAAAAAAAAAAAAAAAAAAJ2mAG2dpgBT//////////8AAAAAAAAAAIFAKkNyNiP/bykm/5iaCf98VR//cDIk/gAAAAAAAAAAAAAAAAAAAACcpgCGoKYAK6BSO7agVDrMnlI5eZ5SOFGmVz3/hzwx/4uCEP97UR//cDEl/3Y5Jf8AAAAAAAAAAAAAAAAAAAAAnaYAnv////+hUzvppVY9/6ZXPf+nVz3/olE8/6J3Lf+PdB7/bS0k/3I3JP9zNyT/cjck72YzGQoAAAAAAAAAAJ6mAKD/////n1Q7UqlYPv+hVDv/oVM7/6FYOf+ekhj/pE4//4dELv9vNSL/cjck/3Q4Jf9yNiT3AAAAAJ6nAJ2bogAh/////wAAAACgVDrMpVY8/6JOPf+fjxv/oVI7/6FUO/+kVj3/h0Qu/281Iv9yNyT/dDgl/3I4JOmktgCVAAAAAP//////////nlI0IqFSPPOhaDL4oX8o/6dUP/+iVTv/oVQ7/6RWPf+GRC7/bzUi/3I3JP91OCX/bislpP////////////////////8AAAAAnK0ArQAAAAAAAAAAoVM78aNVPP+hVDv/pFY9/4ZDLv9zNiT/dTgl/3Y5Jf//////////////////////AAAAAJ2mAK4AAAAAAAAAAJZLLRGhVDr4o1U8/6FUO/+oWj3/pM4AYmwqIoR4Oib/cTYkh////////////////56oAGmepwBxAAAAAAAAAAAAAAAAmUwzFKFRO+ylVT3/pVY9/6RPPoeHQy7Fczck/3E2I7v///////////////+cpQCQnKgAQwAAAAAAAAAAAAAAAAAAAACdrQCPn2oxzahWPv+qWD7/qVg+/4lFL/9vNSHU////////////////nKYAap2lAIAAAAAAAAAAAKGoACacpgC/nqgAZgAAAACUUjEfoVQ6laFUO8OhVDv/oVQ7//////////////////////+dpgCvnqYApZ2nAKSdpgCa////////////////////////////////////////////////AYAAAAByAAA8PQAAPD8AADg9AAAwPAAAABwAAIAKAACAAgAAQAAAACwAAAAuEAAAPwAAAB8AAAAu4AAAAAAAAA=="
      rel="icon"
      type="image/x-icon"
    />
    <link
      rel="shortcut icon"
      href="data:image/x-icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAD//////////////////////////3I2JLdyNyTnczYjUAAAAAD///////////////////////////////////////////////////////////////9yNiPJdTgl/3g6Jv9yNyTKbzcnIAAAAACcpgBQnKYAiZ2lAJmepQBm////////////////AAAAAAAAAAAAAAAAcjcjdHY5Jf9yNiT/ci4m/3I1JPAAAAAAnqUARAAAAAAAAAAAnqcArZmqAA///////////wAAAAAAAAAAAAAAAHI3Ikp2NyX/dDwj/56nAP93RiH2AAAAAAAAAAAAAAAAAAAAAJ2mAG2dpgBT//////////8AAAAAAAAAAIFAKkNyNiP/bykm/5iaCf98VR//cDIk/gAAAAAAAAAAAAAAAAAAAACcpgCGoKYAK6BSO7agVDrMnlI5eZ5SOFGmVz3/hzwx/4uCEP97UR//cDEl/3Y5Jf8AAAAAAAAAAAAAAAAAAAAAnaYAnv////+hUzvppVY9/6ZXPf+nVz3/olE8/6J3Lf+PdB7/bS0k/3I3JP9zNyT/cjck72YzGQoAAAAAAAAAAJ6mAKD/////n1Q7UqlYPv+hVDv/oVM7/6FYOf+ekhj/pE4//4dELv9vNSL/cjck/3Q4Jf9yNiT3AAAAAJ6nAJ2bogAh/////wAAAACgVDrMpVY8/6JOPf+fjxv/oVI7/6FUO/+kVj3/h0Qu/281Iv9yNyT/dDgl/3I4JOmktgCVAAAAAP//////////nlI0IqFSPPOhaDL4oX8o/6dUP/+iVTv/oVQ7/6RWPf+GRC7/bzUi/3I3JP91OCX/bislpP////////////////////8AAAAAnK0ArQAAAAAAAAAAoVM78aNVPP+hVDv/pFY9/4ZDLv9zNiT/dTgl/3Y5Jf//////////////////////AAAAAJ2mAK4AAAAAAAAAAJZLLRGhVDr4o1U8/6FUO/+oWj3/pM4AYmwqIoR4Oib/cTYkh////////////////56oAGmepwBxAAAAAAAAAAAAAAAAmUwzFKFRO+ylVT3/pVY9/6RPPoeHQy7Fczck/3E2I7v///////////////+cpQCQnKgAQwAAAAAAAAAAAAAAAAAAAACdrQCPn2oxzahWPv+qWD7/qVg+/4lFL/9vNSHU////////////////nKYAap2lAIAAAAAAAAAAAKGoACacpgC/nqgAZgAAAACUUjEfoVQ6laFUO8OhVDv/oVQ7//////////////////////+dpgCvnqYApZ2nAKSdpgCa////////////////////////////////////////////////AYAAAAByAAA8PQAAPD8AADg9AAAwPAAAABwAAIAKAACAAgAAQAAAACwAAAAuEAAAPwAAAB8AAAAu4AAAAAAAAA=="
      type="image/x-icon"
    />
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <style>
      :root {
        /* åŸºç¡€é¢œè‰²å˜é‡ */
        --accent-color: #3b82f6;
        --main-color: #0f172a;
        --contrast-color: #f8fafc;
        --accent-rgb: 205, 109, 39;

        /* æ–°å¢å…¨å±€å˜é‡ */
        --bg-color: #ffffff;
        --bg-secondary: #f0f2f5;
        --text-color: #333333;
        --text-secondary: #868e96;
        --border-color: #e5e7eb;
        --shadow-color: rgba(0, 0, 0, 0.1);

        /* ç»„ä»¶ä¸“ç”¨å˜é‡ */
        --table-header-bg: #f8fafc;
        --table-header-hover: #f1f5f9;
        --table-row-even: #f8fafc;
        --form-group-bg: #f8f9fa;
        --form-group-hover: #f1f5f9;
        --input-border: #dee2e6;
        --error-color: #ff4444;
        --button-bg: #f8fafc;
        --button-border: #e2e8f0;
        --default-button-hover: #f1f5f9;
      }

      .night-mode {
        --bg-color: #1a1a1a;
        --bg-secondary: #2d2d2d;
        --text-color: #e5e5e5;
        --text-secondary: #9e9e9e;
        --border-color: #4d4d4d;
        --shadow-color: rgba(255, 255, 255, 0.1);

        --table-header-bg: #2d2d2d;
        --table-header-hover: #3d3d3d;
        --table-row-even: #2a2a2a;
        --form-group-bg: #21252b;
        --form-group-hover: #404040;
        --input-border: #4d4d4d;
        --error-color: #ff6666;
        --button-bg: #404040;
        --button-border: #595959;
        --default-button-hover: #333333;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        padding: 20px;
        background: var(--bg-color);
        color: var(--text-color);
        transition: all 0.3s ease;
      }
      /* ç™»å½•ç•Œé¢ */
      .login-container {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        background: var(--bg-secondary);
      }

      .login-box {
        background: var(--bg-color);
        padding: 2rem;
        border-radius: 8px;
        box-shadow: 0 2px 10px var(--shadow-color);
        width: 400px;
      }

      /* è¡¨å•å®¹å™¨æ ·å¼ */
      .form-group {
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 1rem;
        background: var(--form-group-bg);
        padding: 0.8rem;
        border-radius: 8px;
        transition: all 0.3s ease;
        border: 1px solid var(--border-color);
      }
      .form-group:hover {
        background: var(--form-group-hover);
        box-shadow: 0 2px 6px var(--shadow-color);
      }
      /* æ ‡ç­¾æ ·å¼ */
      .form-group label {
        font-weight: 500;
        color: var(--text-color);
        min-width: 60px;
        font-size: 0.95rem;
      }
      .form-group input {
        width: 80%;
        padding: 0.5rem;
        border: 1px solid var(--input-border);
        border-radius: 4px;
        background: var(--bg-color);
        color: var(--text-color);
      }
      /* é¢œè‰²è¾“å…¥å®¹å™¨ */
      .color-input-container {
        position: relative;
        flex-grow: 1;
      }
      /* åŸç”Ÿè¾“å…¥éšè— */
      input[type="color"] {
        position: absolute;
        opacity: 0;
        width: 100%;
        height: 100%;
        cursor: pointer;
      }
      /* è‡ªå®šä¹‰é¢„è§ˆåŒºåŸŸ */
      .color-preview {
        width: 100%;
        height: 40px;
        border-radius: 6px;
        border: 2px solid var(--border-color);
        background: var(--bg-color);
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
      }
      .color-preview:hover {
        box-shadow: 0 3px 8px var(--shadow-color);
      }
      /* é¢„è§ˆé¢œè‰²æ˜¾ç¤º */
      .color-preview::after {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: var(--selected-color);
      }

      /* æ‚¬åœæ•ˆæœ */
      .color-preview:hover {
        transform: translateY(-1px);
        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
      }
      /* å½“å‰é¢œè‰²æç¤º */
      .color-value {
        font-size: 0.85rem;
        color: #868e96;
        margin-top: 0.5rem;
        text-align: center;
      }
      .error-message {
        color: #ff4444;
        margin-top: 1rem;
      }
      .grid {
        display: grid;
        grid-template-columns: repeat(4, minmax(250px, 1fr));
        gap: var(--gap-size);
        padding: 0 var(--gap-size);
        width: calc(100% - 2 * var(--gap-size));
        margin: 0 auto;
      }

      /* æ·»åŠ å®¹å™¨æ ·å¼ */
      .stat-container {
        display: flex;
        justify-content: space-between;
        padding: 0 10%;
        /* ä¸¤ä¾§é—´è· */
        margin: 20px 0;
      }

      .stat-card {
        background: var(--main-color);
        border: 5px solid var(--accent-color);
        border-radius: 30px;
        padding: 25px;
        color: var(--contrast-color);
        position: relative;
        min-height: 150px;
        box-sizing: border-box;
        width: 18%;
        min-width: 220px;
        margin: 0 1%;
        flex-shrink: 0;
        transition: background 0.3s, border-color 0.3s;
      }

      /* å“åº”å¼å¤„ç† */
      @media (max-width: 1200px) {
        .stat-container {
          flex-wrap: wrap;
          justify-content: flex-start;
        }

        .stat-card {
          width: 48%;
          margin: 1%;
        }
      }

      .stat-label {
        position: absolute;
        bottom: -35px;
        left: 50%;
        transform: translateX(-50%);
        background: var(--accent-color);
        color: var(--contrast-color);
        padding: 6px 25px;
        border-radius: 0 0 4px 4px;
        font-size: 0.9em;
        text-align: center;
        white-space: nowrap;
        z-index: 1;
      }

      .stat-row {
        display: flex;
        align-items: center;
        /* margin: 15px 0; */
        padding: 8px;
        border-bottom: 1px solid #333;
      }

      .stat-icon {
        font-size: 1.4em;
        margin-right: 15px;
        width: 30px;
        text-align: center;
      }

      .stat-value {
        font-size: 1.8em;
        font-weight: 500;
        position: relative;
      }

      .stat-unit {
        font-size: 0.6em;
        vertical-align: super;
        margin-left: 3px;
        color: var(--accent-color);
      }

      .control-bar {
        display: flex;
        gap: 15px;
        background: var(--main-color);
        border-radius: 8px;
        margin: 44px 0;
        align-items: center;
        flex-wrap: wrap;
        justify-content: space-between;
        align-items: center;
        padding: 13px 30px;
      }
      /* æ’é™¤éœ€è¦ä¿æŒä¸»é¢˜è‰²çš„å…ƒç´  */
      .stat-card,
      .control-bar {
        /* ä¿æŒåŸæœ‰ä¸»é¢˜å˜é‡ */
        background: var(--main-color) !important;
        border-color: var(--accent-color) !important;
        color: var(--contrast-color) !important;
      }
      .control-group {
        display: flex;
        align-items: center;
        gap: 15px;
        flex: 1;
      }

      .left {
        justify-content: flex-start;
      }

      .center {
        justify-content: center;
      }

      .right {
        justify-content: flex-end;
      }

      .date-range {
        margin: 0 20px;
        color: var(--contrast-color);
      }

      /* å“åº”å¼å¤„ç† */
      @media (max-width: 768px) {
        .control-bar {
          flex-wrap: wrap;
          gap: 15px;
        }

        .control-group {
          flex: 0 0 100%;
          justify-content: center !important;
        }
      }
      select {
        background: var(--accent-color);
        color: var(--contrast-color);
        border: 1px solid var(--accent-color);
        padding: 8px 15px;
        border-radius: 4px;
      }

      button {
        background: var(--main-color);
        color: var(--contrast-color);
        border: none;
        padding: 8px 15px;
        border-radius: 4px;
        cursor: pointer;
        transition: opacity 0.3s;
      }

      .time-display {
        font-size: 0.9em;
        line-height: 1.4;
      }

      .time-row {
        display: flex;
        gap: 8px;
        align-items: center;
      }

      .time-label {
        color: var(--contrast-color);
        white-space: nowrap;
      }

      .time-value {
        color: var(--contrast-color);
        font-weight: 500;
      }

      .traffic-summary {
        display: flex;
        justify-content: center;
        gap: 2rem;
        margin: -1rem 0;
        font-size: 1.1rem;
      }

      .summary-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        border-radius: 6px;
      }

      .summary-item i {
        font-size: 1.2rem;
      }

      button:hover {
        opacity: 0.9;
      }

      .view-switcher {
        position: relative;
        margin-bottom: 1rem;
        margin-top: -40px;
      }

      .switch-container {
        display: flex;
        top: 10px;
        right: 10px;
        z-index: 10;
        display: flex;
        gap: 8px;
      }
      .view-switch {
        background: var(--bg-color) !important; /* ä½¿ç”¨å…¨å±€èƒŒæ™¯å˜é‡ */
        color: var(--text-color) !important; /* ä½¿ç”¨å…¨å±€æ–‡å­—é¢œè‰² */
        transition: all 0.2s;
      }
      .view-switch.active {
        border-color: var(--accent-color) !important;
        color: var(--accent-color) !important;
      }
      .data-table {
        border: 1px solid var(--border-color);
        border-radius: 8px;
        overflow: hidden;
        background: var(--bg-color);
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9em;
        color: var(--text-color);
      }

      th {
        background: var(--table-header-bg);
        padding: 12px 16px;
        text-align: left;
        font-weight: 600;
        border-bottom: 2px solid var(--border-color);
        cursor: pointer;
        user-select: none;
        transition: background 0.2s;
      }
      th:hover {
        background: var(--table-header-hover);
      }

      th i {
        margin-left: 8px;
        font-size: 0.8em;
        color: var(--table-header-icon);
      }

      td {
        padding: 12px 16px;
        border-bottom: 1px solid var(--border-color);
      }

      tr:nth-child(even) {
        background: var(--table-row-even);
      }
      /* API è®¾ç½®æŒ‰é’®å’Œå¼¹çª—æ ·å¼ */
      .settings-button {
        font-size: 17px;
        position: fixed;
        top: 30px;
        right: 25px;
        background: #ffffff00;
        color: color-mix(in srgb, var(--accent-color) 50%, transparent);
        border: none;
        border-radius: 4px;
        padding: 8px 15px;
        transition: all 0.3s;
        cursor: pointer;
        z-index: 1000;
      }
      .settings-button:hover {
        color: var(--accent-color);
        transform: rotate(15deg);
      }
      .settings-button.api-btn {
        right: 25px;
      }
      .settings-button.theme-btn {
        right: 55px;
      }
      .settings-button.night-btn {
        right: 85px;
      }
      .settings-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 2000;
      }

      .settings-content {
        background: var(--bg-color);
        color: var(--text-color);
        border-radius: 8px;
        padding: 20px;
        width: 600px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      }

      .settings-content h3 {
        margin-top: 0;
        margin-bottom: 20px;
        color: var(--text-color);
      }
      .settings-buttons {
        display: flex;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
      }
      .settings-buttons button {
        padding: 8px 15px;
        cursor: pointer;
      }
      .default-button {
        background: var(--button-bg);
        color: var(--text-secondary);
        border: 1px solid var(--border-color);
      }
      .default-button:hover {
        background: var(--default-button-hover);
      }
      .save-button {
        background: var(--accent-color);
        color: var(--contrast-color);
      }
      .cancel-button {
        background: #f0f0f0;
        color: #333;
      }
      .preset-themes {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
      }

      .preset-theme {
        position: relative;
        height: 80px;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        overflow: hidden;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      }

      .preset-theme:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }
      .preset-theme::after {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        border: 2px solid var(--accent-color);
        border-radius: 6px;
        opacity: 0;
        transition: opacity 0.3s;
      }

      .preset-theme.active::after {
        opacity: 1;
      }

      .theme-name {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: rgba(0, 0, 0, 0.7);
        color: #f0f2f5;
        padding: 0.5rem;
        font-size: 0.8rem;
        text-align: center;
      }
      .msg-container {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 9999;
      }

      .message {
        background: #f4f4f5;
        color: #606266;
        padding: 12px 20px;
        border-radius: 4px;
        box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
        transition: all 0.3s;
        opacity: 0;
        transform: translateY(-20px);
        margin-bottom: 10px;
        display: flex;
        align-items: center;
      }

      .message.show {
        opacity: 1;
        transform: translateY(0);
      }

      .message::before {
        content: "ğŸ””";
        margin-right: 8px;
      }

      /* å¤œé—´æ¨¡å¼é€‚é… */
      .night-mode .message {
        background: #2d2d2d;
        color: #e5e5e5;
        box-shadow: 0 2px 12px 0 rgba(255, 255, 255, 0.1);
      }
    </style>
  </head>

  <body>
    <div id="app">
      <button class="settings-button api-btn" @click="showApiSettings">
        <i class="fas fa-cog"></i>
      </button>
      <button class="settings-button theme-btn" @click="showThemeSettings">
        <i class="fas fa-palette"></i>
      </button>
      <button class="settings-button night-btn" @click="toggleNightMode">
        <i :class="isNightMode ? 'fas fa-sun' : 'fas fa-moon'"></i>
      </button>
      <div class="settings-modal" v-if="themeSettingsVisible">
        <div class="settings-content">
          <h3>ä¸»é¢˜é…ç½®</h3>
          <!-- é¢„è®¾ä¸»é¢˜ -->
          <div class="preset-themes">
            <div
              v-for="(theme, index) in presetThemes"
              :key="index"
              class="preset-theme"
              :style="getPresetStyle(theme)"
              @click="applyPresetTheme(theme)"
            >
              <div class="theme-name">{{ theme.name }}</div>
            </div>
          </div>
          <div class="form-group">
            <label>å¼ºè°ƒè‰²ï¼š</label>
            <div class="color-input-container">
              <input type="color" v-model="theme.accent" />
              <div
                class="color-preview"
                :style="{'--selected-color': theme.accent}"
              ></div>
              <div class="color-value">{{ theme.accent }}</div>
            </div>
          </div>

          <div class="form-group">
            <label>ä¸»ä½“è‰²ï¼š</label>
            <div class="color-input-container">
              <input type="color" v-model="theme.main" />
              <div
                class="color-preview"
                :style="{'--selected-color': theme.main}"
              ></div>
              <div class="color-value">{{ theme.main }}</div>
            </div>
          </div>

          <div class="form-group">
            <label>å¯¹æ¯”è‰²ï¼š</label>
            <div class="color-input-container">
              <input type="color" v-model="theme.contrast" />
              <div
                class="color-preview"
                :style="{'--selected-color': theme.contrast}"
              ></div>
              <div class="color-value">{{ theme.contrast}}</div>
            </div>
          </div>
          <div class="form-group">
            <label>ä¸Šè¡Œï¼š</label>
            <div class="color-input-container">
              <input type="color" v-model="theme.upload" />
              <div
                class="color-preview"
                :style="{'--selected-color': theme.upload}"
              ></div>
              <div class="color-value">{{ theme.upload }}</div>
            </div>
          </div>
          <div class="form-group">
            <label>ä¸‹è¡Œï¼š</label>
            <div class="color-input-container">
              <input type="color" v-model="theme.download" />
              <div
                class="color-preview"
                :style="{'--selected-color': theme.download}"
              ></div>
              <div class="color-value">{{ theme.download }}</div>
            </div>
          </div>
          <div class="settings-buttons">
            <button class="default-button" @click="resetDefaultTheme">
              <i class="fas fa-undo"></i> æ¢å¤é»˜è®¤
            </button>
            <button class="cancel-button" @click="cancelThemeSettings">
              å–æ¶ˆ
            </button>
            <button class="save-button" @click="saveThemeSettings">ä¿å­˜</button>
          </div>
        </div>
      </div>
      <div class="settings-modal" v-if="apiSettingsVisible">
        <div class="settings-content">
          <h3>é¡µé¢é…ç½®</h3>
          <div class="form-group">
            <label>APIæ¥å£ï¼š</label>
            <input
              type="text"
              v-model="assistApi"
              placeholder="è¯·è¾“å…¥APIåœ°å€"
            />
          </div>
          <!-- æ–°å¢å¤‡ä»½æ•°æ®å¼€å…³ -->
          <div class="form-group">
            <label>è°ƒç”¨å¤‡ä»½æ•°æ®ï¼š</label>
            <label class="switch">
              <input type="checkbox" v-model="enableBackupData" />
              <span class="slider round"></span>
            </label>
          </div>

          <div class="settings-buttons">
            <button class="cancel-button" @click="cancelApiSettings">
              å–æ¶ˆ
            </button>
            <button class="save-button" @click="saveApiSettings">ä¿å­˜</button>
          </div>
        </div>
      </div>
      <!-- ç™»å½•ç•Œé¢ -->
      <div v-if="!isAuthenticated" class="login-container">
        <div class="login-box">
          <h2>ç½‘ç»œæµé‡ç»Ÿè®¡ç³»ç»Ÿ</h2>
          <form @submit.prevent="handleLogin">
            <div class="form-group">
              <label><i class="fas fa-user"></i> ç”¨æˆ·å</label>
              <input type="text" v-model="loginForm.username" required />
            </div>
            <div class="form-group">
              <label><i class="fas fa-lock"></i> å¯†ç </label>
              <input type="password" v-model="loginForm.password" required />
            </div>
            <button type="submit" :disabled="loggingIn">
              {{ loggingIn ? 'ç™»å½•ä¸­...' : 'ç™»å½•' }}
            </button>
            <div v-if="loginError" class="error-message">{{ loginError }}</div>
          </form>
        </div>
      </div>
      <div v-else>
        <!-- ç»Ÿè®¡å¡ç‰‡ -->
        <div class="stat-container" v-if="currentInterface">
          <!-- æ€»ç»Ÿè®¡ -->
          <div class="stat-card">
            <div class="stat-row">
              <i class="fas fa-tachometer-alt stat-icon"></i>
              <div class="stat-value">
                {{ formatSum(currentInterface.traffic.total).value }}
                <span class="stat-unit"
                  >{{ formatSum(currentInterface.traffic.total).unit }}</span
                >
              </div>
            </div>
            <div class="stat-row">
              <i class="fas fa-arrow-down stat-icon"></i>
              <div class="stat-value">
                {{ formatBytes(currentInterface.traffic.total.rx).value }}
                <span class="stat-unit"
                  >{{ formatBytes(currentInterface.traffic.total.rx).unit
                  }}</span
                >
              </div>
            </div>
            <div class="stat-row">
              <i class="fas fa-arrow-up stat-icon"></i>
              <div class="stat-value">
                {{ formatBytes(currentInterface.traffic.total.tx).value }}
                <span class="stat-unit"
                  >{{ formatBytes(currentInterface.traffic.total.tx).unit
                  }}</span
                >
              </div>
            </div>
            <div class="stat-label">æ€»è®¡</div>
          </div>
          <div
            class="stat-card"
            v-for="(data, title) in summaryData"
            :key="title"
          >
            <div class="stat-row">
              <i class="fas fa-chart-bar stat-icon"></i>
              <div class="stat-value">
                {{ formatSum(data).value }}
                <span class="stat-unit">{{ formatSum(data).unit }}</span>
              </div>
            </div>
            <div class="stat-row">
              <i class="fas fa-arrow-down stat-icon"></i>
              <div class="stat-value">
                {{ formatBytes(data.rx).value }}
                <span class="stat-unit">{{ formatBytes(data.rx).unit }}</span>
              </div>
            </div>
            <div class="stat-row">
              <i class="fas fa-arrow-up stat-icon"></i>
              <div class="stat-value">
                {{ formatBytes(data.tx).value }}
                <span class="stat-unit">{{ formatBytes(data.tx).unit }}</span>
              </div>
            </div>
            <div class="stat-label">{{ title.toUpperCase() }}</div>
          </div>
        </div>

        <!-- ä¿®æ”¹åçš„æ§åˆ¶æ¡ç»“æ„ -->
        <div class="control-bar">
          <!-- å·¦ä¾§æ§ä»¶ -->
          <div class="control-group left" v-show="!interfacesDataMode">
            <select v-model="timeRangeType">
              <option value="hour">æŒ‰æ—¶</option>
              <option value="day">æŒ‰æ—¥</option>
              <option value="month">æŒ‰æœˆ</option>
              <option value="year">æŒ‰å¹´</option>
            </select>
          </div>
          <div class="control-group center" v-show="!interfacesDataMode">
            <button class="control-button" @click="adjustTime(-1)">
              <i class="fas fa-chevron-left"></i>
            </button>
            <span class="date-range">{{ dateRange }}</span>
            <button
              class="control-button"
              :style="{ visibility: showNextButton ? 'visible' : 'hidden' }"
              @click="adjustTime(1)"
            >
              <i class="fas fa-chevron-right"></i>
            </button>
          </div>

          <!-- å³ä¾§ç½‘å¡é€‰æ‹© -->
          <div class="control-group right">
            <div class="time-display" v-if="latestSelectedInterfaceData">
              <div class="time-row">
                <span class="time-label">ç»Ÿè®¡å¼€å§‹ï¼š</span>
                <span class="time-value"
                  >{{ formatTime(latestSelectedInterfaceData.created) }}</span
                >
              </div>
              <div class="time-row">
                <span class="time-label">æœ€åæ›´æ–°ï¼š</span>
                <span class="time-value"
                  >{{ formatTime(latestSelectedInterfaceData.updated) }}</span
                >
              </div>
            </div>
            <select
              v-model="latestSelectedInterfaceData"
              v-show="!interfacesDataMode"
            >
              <option v-for="iface in latestInterfacesData" :value="iface">
                {{ iface.name }}
              </option>
            </select>
            <button
              class="control-button"
              title="æŒ‰ç½‘å¡ç»Ÿè®¡"
              @click="handleShowInterfaceData()"
            >
              <i class="fas fa-network-wired"></i>
            </button>
          </div>
        </div>
        <div v-show="!interfacesDataMode">
          <div class="traffic-summary">
            <div class="summary-item" title="ä¸Šè¡Œæµé‡">
              <i class="fas fa-upload text-blue-500"></i>
              <span>{{ uploadGB }}</span>
            </div>
            <div class="summary-item" title="æ€»æµé‡">
              <i class="fas fa-exchange-alt text-purple-500"></i>
              <span>{{ totalGB }}</span>
            </div>
            <div class="summary-item" title="ä¸‹è¡Œæµé‡">
              <i class="fas fa-download text-green-500"></i>
              <span>{{ downloadGB }}</span>
            </div>
          </div>
          <!-- åœ¨å›¾è¡¨å®¹å™¨ä¸Šæ–¹æ·»åŠ  -->
          <div class="view-switcher right">
            <div class="switch-container">
              <button
                @click="currentView = 'chart'"
                class="view-switch"
                :class="{active: currentView === 'chart'} "
                title="å›¾è¡¨è§†å›¾"
              >
                <i class="fas fa-chart-line"></i>
              </button>
              <button
                @click="currentView = 'table'"
                class="view-switch"
                :class="{active: currentView === 'table'}"
                title="è¡¨æ ¼è§†å›¾"
              >
                <i class="fas fa-table"></i>
              </button>
            </div>
          </div>
          <!-- å›¾è¡¨å®¹å™¨ -->
          <div class="chart-container">
            <div v-show="currentView === 'chart'" id="trafficChart"></div>
            <div v-show="currentView === 'table'" class="data-table">
              <table>
                <thead>
                  <tr>
                    <th @click="sortTable('timestamp')">
                      æ—¥æœŸ/æ—¶é—´
                      <i class="fas" :class="sortIcon('timestamp')"></i>
                    </th>
                    <th @click="sortTable('tx')">
                      ä¸Šè¡Œ
                      <i class="fas" :class="sortIcon('tx')"></i>
                    </th>
                    <th @click="sortTable('rx')">
                      ä¸‹è¡Œ
                      <i class="fas" :class="sortIcon('rx')"></i>
                    </th>
                    <th>æ€»è®¡</th>
                  </tr>
                </thead>
                <tbody>
                  <tr v-for="item in sortedTableData" :key="item.timestamp">
                    <td>{{ getformatTableTime(item.date,item.time) }}</td>
                    <td>
                      {{ formatBytes(item.tx).value+formatBytes(item.tx).unit }}
                    </td>
                    <td>
                      {{ formatBytes(item.rx).value +formatBytes(item.rx).unit}}
                    </td>
                    <td>
                      {{ formatBytes(item.tx +
                      item.rx).value+formatBytes(item.tx + item.rx).unit }}
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
        <!-- ç½‘å¡ç»Ÿè®¡è¡¨æ ¼ -->
        <div v-show="interfacesDataMode" class="data-table">
          <table>
            <thead>
              <tr>
                <th @click="sortTable('name')">
                  ç½‘å¡åç§°
                  <i class="fas" :class="sortIcon('name')"></i>
                </th>
                <th @click="sortTable('todayRx')">
                  ä»Šæ—¥ä¸‹è¡Œ
                  <i class="fas" :class="sortIcon('todayRx')"></i>
                </th>
                <th @click="sortTable('todayTx')">
                  ä»Šæ—¥ä¸Šè¡Œ
                  <i class="fas" :class="sortIcon('todayTx')"></i>
                </th>
                <th @click="sortTable('todayTotal')">
                  ä»Šæ—¥æ€»è®¡
                  <i class="fas" :class="sortIcon('todayTotal')"></i>
                </th>
                <th @click="sortTable('totalRx')">
                  å…¨éƒ¨ä¸‹è¡Œ
                  <i class="fas" :class="sortIcon('totalRx')"></i>
                </th>
                <th @click="sortTable('totalTx')">
                  å…¨éƒ¨ä¸Šè¡Œ
                  <i class="fas" :class="sortIcon('totalTx')"></i>
                </th>
                <th @click="sortTable('totalTotal')">
                  å…¨éƒ¨æ€»è®¡
                  <i class="fas" :class="sortIcon('totalTotal')"></i>
                </th>
              </tr>
            </thead>
            <tbody>
              <tr v-for="item in sortedInterfaces" :key="item.name">
                <td>{{ item.name }}</td>
                <td>
                  {{ formatBytes(item.todayRx).value }}{{
                  formatBytes(item.todayRx).unit }}
                </td>
                <td>
                  {{ formatBytes(item.todayTx).value }}{{
                  formatBytes(item.todayTx).unit }}
                </td>
                <td>
                  {{ formatBytes(item.todayTotal).value }}{{
                  formatBytes(item.todayTotal).unit }}
                </td>
                <td>
                  {{ formatBytes(item.totalRx).value }}{{
                  formatBytes(item.totalRx).unit }}
                </td>
                <td>
                  {{ formatBytes(item.totalTx).value }}{{
                  formatBytes(item.totalTx).unit }}
                </td>
                <td>
                  {{ formatBytes(item.totalTotal).value }}{{
                  formatBytes(item.totalTotal).unit }}
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <script>
      new Vue({
        el: "#app",
        data: {
          // è®¤è¯ç›¸å…³æ•°æ®
          isAuthenticated: true,
          loginForm: { username: "", password: "" },
          loggingIn: false,
          loginError: "",
          authToken: null,
          latestRawData: {},
          latestInterfacesTableData: [],
          latestInterfacesData: [],
          latestSelectedInterfaceData: null,
          chart: null,
          timeRangeType: "day",
          currentRange: new Date(),
          currentStats: {},
          currentView: "chart",
          filteredData: [],
          isNightMode: false,
          interfacesDataMode: false,
          showNextButton: false,
          sortKey: "name",
          sortOrder: "asc",
          defaultInterface: "enp3s0",
          apiSettingsVisible: false,
          themeSettingsVisible: false,
          assistApi: null,
          url: {},
          // å¤‡ä»½æ•°æ®å¯ç”¨
          enableBackupData: null,
          // å†…å­˜ç¼“å­˜ {dateStr: data}
          backupCache: {},
          //ç»´æŠ¤é”®é¡ºåº
          cacheKeys: [],
          pendingBackups: new Set(),
          theme: {
            name: "ç§‘æŠ€è“",
            main: "#0f172a",
            accent: "#3b82f6",
            contrast: "#f8fafc",
            upload: "#93c5fd",
            download: "#60a5fa",
          },
          presetThemes: [
            {
              name: "ç§‘æŠ€è“",
              main: "#0f172a",
              accent: "#3b82f6",
              contrast: "#f8fafc",
              upload: "#93c5fd",
              download: "#60a5fa",
            },
            {
              name: "æ´»åŠ›æ©™",
              main: "#1e293b",
              accent: "#f59e0b",
              contrast: "#fff7ed",
              upload: "#fcd34d",
              download: "#fb923c",
            },
            {
              name: "æ¸…æ–°ç»¿",
              main: "#1c1917",
              accent: "#10b981",
              contrast: "#ecfdf5",
              upload: "#6ee7b7",
              download: "#34d399",
            },
            {
              name: "å¹»å½±ç´«",
              main: "#1a1b26",
              accent: "#9d7cde",
              contrast: "#f8f5ff",
              upload: "#b9a4e6",
              download: "#7f5fd3",
            },
            {
              name: "ç«ç‘°ç²‰",
              main: "#2d2d2d",
              accent: "#ff6b6b",
              contrast: "#fff0f0",
              upload: "#ff9d9d",
              download: "#ff5252",
            },
          ],
          defaultTheme: {
            name: "ç§‘æŠ€è“",
            main: "#0f172a",
            accent: "#3b82f6",
            contrast: "#f8fafc",
            upload: "#93c5fd",
            download: "#60a5fa",
          },
        },
        computed: {
          uploadGB() {
            return (
              this.formatBytes(this.currentStats.tx).value +
              this.formatBytes(this.currentStats.tx).unit
            );
          },
          downloadGB() {
            return (
              this.formatBytes(this.currentStats.rx).value +
              this.formatBytes(this.currentStats.rx).unit
            );
          },
          totalGB() {
            return (
              this.formatBytes(this.currentStats.total).value +
              this.formatBytes(this.currentStats.total).unit
            );
          },
          currentInterface() {
            return (
              this.latestSelectedInterfaceData || this.latestInterfacesData[0]
            );
          },
          summaryData() {
            const latestInterfacesData =
              this.latestSelectedInterfaceData || this.latestInterfacesData[0];
            return {
              æœ¬æœˆ: this.getMonthData(latestInterfacesData),
              ä»Šæ—¥: this.getDayData(latestInterfacesData),
              æ˜¨æ—¥: this.getYesterdayData(latestInterfacesData),
            };
          },
          sortedInterfaces() {
            return [...this.latestInterfacesTableData].sort((a, b) => {
              let modifier = -1;
              if (this.sortOrder === "asc") modifier = 1;
              if (a[this.sortKey] < b[this.sortKey]) return -1 * modifier;
              if (a[this.sortKey] > b[this.sortKey]) return 1 * modifier;
              return 0;
            });
          },
          sortedTableData() {
            return [...this.filteredData].sort((a, b) => {
              let modifier = -1;
              if (this.sortOrder === "asc") modifier = 1;
              if (a[this.sortKey] < b[this.sortKey]) return -1 * modifier;
              if (a[this.sortKey] > b[this.sortKey]) return 1 * modifier;
              return 0;
            });
          },
          dateRange() {
            const d = new Date(this.currentRange);
            const format = (date, withDay = true, withTime = false) => {
              let result = `${date.getFullYear()}-${String(
                date.getMonth() + 1
              ).padStart(2, "0")}${
                withDay ? `-${String(date.getDate()).padStart(2, "0")}` : ""
              }`;
              if (withTime) {
                result += ` ${String(date.getHours()).padStart(2, "0")}:00`;
              }
              return result;
            };
            switch (this.timeRangeType) {
              case "hour":
                const hourStart = new Date(d);
                hourStart.setMinutes(0, 0, 0);
                const hourEnd = new Date(hourStart);
                hourEnd.setHours(hourStart.getHours() + 1);
                return `${format(hourStart, true, true)} - ${format(
                  hourEnd,
                  true,
                  true
                )}`;
              case "day":
                const day = new Date(d);
                return `${format(day)}`;
              case "month":
                const start = new Date(d.getFullYear(), d.getMonth(), 1);
                const end = new Date(d.getFullYear(), d.getMonth() + 1, 0);
                return `${format(start)} - ${format(end)}`;
              case "year":
                return `${d.getFullYear()}å¹´`;
            }
          },
        },
        watch: {
          timeRangeType() {
            this.showNextButton = false;
            (this.currentRange = new Date()), this.updateChart();
          },
          currentDate() {
            this.updateChart();
          },
          latestSelectedInterfaceData() {
            this.updateChart();
          },
          theme: {
            deep: true,
            handler(newTheme) {
              this.saveThemeColors();
            },
          },
        },
        methods: {
          // ç™»å½•é€»è¾‘
          async handleLogin() {
            if (!this.assistApi) {
              alert("è¯·å…ˆç‚¹å‡»å³ä¸Šè§’è®¾ç½®ç»Ÿä¸€APIå…¥å£");
              return;
            }
            this.loggingIn = true;
            this.loginError = "";
            try {
              const response = await fetch(this.url.login, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(this.loginForm),
              });
              if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || "ç™»å½•å¤±è´¥");
              }
              const { token } = await response.json();
              this.handleAuthSuccess(token);
            } catch (err) {
              this.loginError = err.message || "ç™»å½•è¯·æ±‚å¤±è´¥";
            } finally {
              this.loggingIn = false;
            }
          },
          // è®¤è¯æˆåŠŸå¤„ç†
          handleAuthSuccess(token) {
            // å­˜å‚¨Token
            localStorage.setItem("jwt_token", token);
            this.authToken = token;
            this.isAuthenticated = true;
            // åŠ è½½æ•°æ®
            this.loadData();
          },
          // æ³¨é”€å¤„ç†
          handleLogout() {
            localStorage.removeItem("jwt_token");
            this.isAuthenticated = false;
            this.authToken = null;
          },
          async loadData() {
            const response = await this.fetchWithAuth(this.url.loadJson);
            this.latestRawData = await response.json();
            this.latestInterfacesData = this.latestRawData.interfaces;
            if (this.latestInterfacesData.length > 0) {
              const defaultInterface = this.latestInterfacesData.find(
                (intf) => intf.name === this.defaultInterface
              );
              this.latestSelectedInterfaceData =
                defaultInterface || this.latestInterfacesData[0];
            }
            await this.$nextTick();
          },
          async fetchWithAuth(url, options = {}) {
            const response = await fetch(url, {
              ...options,
              headers: {
                Authorization: `Bearer ${this.authToken}`,
                ...options.headers,
              },
            });
            if (response.status === 401) {
              this.handleLogout();
            }
            return response;
          },
          formatBytes(bytes) {
            const units = ["B", "KB", "MB", "GB", "TB"];
            let i = 0;
            bytes = Number(bytes);
            while (bytes >= 1024 && i < units.length - 1) {
              bytes /= 1024;
              i++;
            }
            return {
              value: bytes.toFixed(2),
              unit: units[i],
            };
          },
          formatSum(data) {
            const total = data.rx + data.tx;
            return this.formatBytes(total);
          },
          getMonthData(interface) {
            const year = new Date().getFullYear();
            const month = new Date().getMonth() + 1;
            return (
              interface.traffic.month.find(
                (d) => d.date.year === year && d.date.month === month
              ) || { rx: 0, tx: 0 }
            );
          },
          getDayData(interface) {
            const year = new Date().getFullYear();
            const month = new Date().getMonth() + 1;
            const day = new Date().getDate();
            return (
              interface.traffic.day.find(
                (d) =>
                  d.date.year === year &&
                  d.date.month === month &&
                  d.date.day === day
              ) || { rx: 0, tx: 0 }
            );
          },
          getYesterdayData(interface) {
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(today.getDate() - 1);
            const year = yesterday.getFullYear();
            const month = yesterday.getMonth() + 1;
            const day = yesterday.getDate();
            return (
              interface.traffic.day.find(
                (d) =>
                  d.date.year === year &&
                  d.date.month === month &&
                  d.date.day === day
              ) || { rx: 0, tx: 0 }
            );
          },
          adjustTime(offset) {
            const d = new Date(this.currentRange);
            const now = new Date();
            let isLimitReached = false;
            // ä¿å­˜åŸå§‹æ—¥æœŸï¼ˆç”¨äºé—°å¹´å¤„ç†ï¼‰
            const originalDate = d.getDate();
            const originalMonth = d.getMonth();
            switch (this.timeRangeType) {
              case "hour":
                // è‡ªåŠ¨å¤„ç†è·¨æ—¥/æœˆ/å¹´
                d.setTime(d.getTime() + offset * 60 * 60 * 1000);
                // ç²¾ç¡®æ¯”è¾ƒåˆ°å°æ—¶çº§åˆ«
                isLimitReached =
                  d.getFullYear() === now.getFullYear() &&
                  d.getMonth() === now.getMonth() &&
                  d.getDate() === now.getDate() &&
                  d.getHours() === now.getHours();
                break;
              case "day":
                d.setDate(d.getDate() + offset);
                // æ¯”è¾ƒæ—¥æœŸéƒ¨åˆ†
                isLimitReached = this.isSameDay(d, now);
                break;
              case "month":
                // å…ˆè®¾ç½®ä¸ºå½“æœˆç¬¬ä¸€å¤©ï¼Œé¿å…è·¨æœˆæ—¶çš„æ—¥æœŸæº¢å‡ºé—®é¢˜
                d.setDate(1);
                d.setMonth(d.getMonth() + offset);
                // å¤„ç†è·¨æœˆè°ƒæ•´åçš„æ—¥æœŸæœ‰æ•ˆæ€§ï¼ˆå¦‚1æœˆ31æ—¥â†’2æœˆ28/29æ—¥ï¼‰
                const maxDays = new Date(
                  d.getFullYear(),
                  d.getMonth() + 1,
                  0
                ).getDate();
                d.setDate(Math.min(originalDate, maxDays));
                isLimitReached =
                  d.getFullYear() === now.getFullYear() &&
                  d.getMonth() === now.getMonth();
                break;
              case "year":
                const targetYear = d.getFullYear() + offset;
                d.setFullYear(targetYear);
                // å¤„ç†é—°å¹´2æœˆ29æ—¥çš„æƒ…å†µ
                if (originalMonth === 1 && originalDate === 29) {
                  const isLeapYear = (year) =>
                    (year % 4 === 0 && year % 100 !== 0) || year % 400 === 0;
                  if (!isLeapYear(targetYear)) {
                    d.setMonth(1); // February
                    d.setDate(28);
                  }
                }
                isLimitReached = d.getFullYear() === now.getFullYear();
                break;
            }
            this.showNextButton = !isLimitReached;
            this.currentRange = d;
            this.updateChart();
          },
          //æ¯”è¾ƒä¸¤ä¸ªæ—¥æœŸæ˜¯å¦æ˜¯åŒä¸€å¤©
          isSameDay(date1, date2) {
            return (
              date1.getFullYear() === date2.getFullYear() &&
              date1.getMonth() === date2.getMonth() &&
              date1.getDate() === date2.getDate()
            );
          },
          showApiSettings() {
            this.apiSettingsVisible = !this.apiSettingsVisible;
          },
          normalizeUrl(url) {
            const trimmedUrl = url.trim();
            if (/^\/\//.test(trimmedUrl)) {
              return `http:${trimmedUrl}`;
            }
            if (!/^https?:\/\//i.test(trimmedUrl)) {
              return `http://${trimmedUrl}`;
            }
            return trimmedUrl;
          },
          saveApiSettings() {
            this.assistApi = this.normalizeUrl(this.assistApi);
            localStorage.setItem("assist_api", this.assistApi);
            localStorage.setItem("enable_backup", this.enableBackupData);
            if (!this.enableBackupData) {
              localStorage.removeItem("backup_data");
            }
            this.apiSettingsVisible = false;
            if (this.isAuthenticated) {
              this.loadData();
            }
          },
          cancelApiSettings() {
            this.apiSettingsVisible = false;
          },
          showThemeSettings() {
            console.log(this.presetThemes);
            this.themeSettingsVisible = !this.themeSettingsVisible;
          },
          saveThemeSettings() {
            // æ£€æŸ¥æ˜¯å¦æ˜¯é¢„è®¾ä¸»é¢˜
            const isPreset = this.presetThemes.some(
              (preset) =>
                preset.main === this.theme.main &&
                preset.accent === this.theme.accent &&
                preset.contrast === this.theme.contrast &&
                preset.upload === this.theme.upload &&
                preset.download === this.theme.download
            );
            if (!isPreset) {
              this.theme.name = "è‡ªå®šä¹‰";
              const customTheme = { ...this.theme };
              const filteredThemes = this.presetThemes.filter(
                (t) => t.name !== "è‡ªå®šä¹‰"
              );
              this.presetThemes = [...filteredThemes, customTheme];
            }
            this.saveThemeColors();
            localStorage.setItem("themeColors", JSON.stringify(this.theme));
            this.updateChart();
            this.cancelThemeSettings();
          },
          cancelThemeSettings() {
            this.themeSettingsVisible = false;
          },
          //åº”ç”¨é¢„è®¾
          applyPresetTheme(preset) {
            this.theme = { ...preset };
            this.saveThemeColors();
            localStorage.setItem("themeColors", JSON.stringify(this.theme));
          },
          // æ¢å¤é»˜è®¤
          resetDefaultTheme() {
            this.theme = { ...this.defaultTheme };
            this.saveThemeColors();
            localStorage.setItem("themeColors", JSON.stringify(this.theme));
          },
          getPresetStyle(theme) {
            return {
              "--main-color": theme.main,
              "--accent-color": theme.accent,
              background: `linear-gradient(135deg, ${theme.main} 50%, ${theme.accent} 50%)`,
            };
          },
          toggleNightMode(arg) {
            if (arg == 1) {
              this.isNightMode = true;
            } else {
              this.isNightMode = !this.isNightMode;
            }
            const htmlEl = document.documentElement;
            if (this.isNightMode) {
              htmlEl.classList.add("night-mode");
            } else {
              htmlEl.classList.remove("night-mode");
            }
            // localStorage.setItem('nightMode', this.isNightMode)
          },
          handleShowInterfaceData() {
            if (this.interfacesDataMode) {
              this.interfacesDataMode = false;
              this.updateChart();
            } else {
              this.interfacesDataMode = true;
              this.handleLatestInterfacesData();
            }
          },
          sortTable(key) {
            if (this.sortKey === key) {
              this.sortOrder = this.sortOrder === "asc" ? "desc" : "asc";
            } else {
              this.sortKey = key;
              this.sortOrder = "desc";
            }
          },
          sortIcon(key) {
            if (this.sortKey !== key) return "fa-sort";
            return this.sortOrder === "asc" ? "fa-sort-up" : "fa-sort-down";
          },
          handleLatestInterfacesData() {
            this.latestInterfacesTableData = this.latestInterfacesData.map(
              (item) => {
                const todayData = this.getDayData(item);
                return {
                  name: item.name,
                  todayRx: todayData.rx,
                  todayTx: todayData.tx,
                  todayTotal: todayData.rx + todayData.tx,
                  totalRx: item.traffic.total.rx,
                  totalTx: item.traffic.total.tx,
                  totalTotal: item.traffic.total.rx + item.traffic.total.tx,
                };
              }
            );
          },
          async getMergedSeriesData() {
            const dataType = {
              hour: "fiveminute",
              day: "hour",
              month: "day",
              year: "month",
            }[this.timeRangeType];
            const currentDate = new Date(this.currentRange);
            const isPastDate = this.isPastDate(currentDate);
            // åˆ¤æ–­æ˜¯å¦éœ€è¦ä½¿ç”¨å¤‡ä»½æ•°æ®
            let useBackup =
              this.enableBackupData &&
              isPastDate &&
              (this.timeRangeType === "hour" || this.timeRangeType === "day");
            if (useBackup) {
              const dateStr = this.getDateString(currentDate);
              const backupData = await this.getBackupData(dateStr);
              if (backupData) {
                return this.processBackupData(
                  currentDate,
                  backupData,
                  dataType
                );
              }
            }
            //åŸæœ‰å¤„ç†é€»è¾‘
            const latestRawData =
              this.latestSelectedInterfaceData.traffic[dataType];
            return this.processData(currentDate, latestRawData, dataType);
          },
          //åˆ¤æ–­æ˜¯å¦æ˜¯è¿‡å»æ—¥æœŸï¼Œä¿é™©èµ·è§æ˜¨å¤©ä¹‹å‰çš„æ•°æ®éƒ½ä»å¤‡ä»½ä¸­è·å–
          isPastDate(date) {
            const now = new Date();
            const compareDate = new Date(date);
            compareDate.setHours(23, 59, 59, 999);
            return compareDate < now;
          },
          //è·å–æ—¥æœŸå­—ç¬¦ä¸²
          getDateString(date) {
            return [
              date.getFullYear(),
              String(date.getMonth() + 1).padStart(2, "0"),
              String(date.getDate()).padStart(2, "0"),
            ].join("");
          },
          processData(currentDate, rawData, dataType) {
            let totalRx = 0,
              totalTx = 0;
            const rangeYear = currentDate.getFullYear();
            const rangeMonth = currentDate.getMonth() + 1;
            const rangeDay = currentDate.getDate();
            const rangeHour = currentDate.getHours();
            this.filteredData = rawData.filter((item) => {
              let match = false;
              switch (this.timeRangeType) {
                case "hour":
                  var itemYear = item.date.year;
                  var itemMonth = item.date.month;
                  var itemDay = item.date.day;
                  var itemHour = item.time ? item.time.hour : 0;
                  match =
                    itemYear === rangeYear &&
                    itemMonth === rangeMonth &&
                    itemDay === rangeDay &&
                    itemHour === rangeHour;
                  break;
                case "day":
                  var itemYear = item.date.year;
                  var itemMonth = item.date.month;
                  var itemDay = item.date.day;
                  match =
                    itemYear === rangeYear &&
                    itemMonth === rangeMonth &&
                    itemDay === rangeDay;
                  break;
                case "month":
                  var itemYear = item.date.year;
                  var itemMonth = item.date.month;
                  var itemDay = item.date.day;
                  match = itemYear === rangeYear && itemMonth === rangeMonth;
                  break;
                case "year":
                  var itemYear = item.date.year;
                  match = itemYear === rangeYear;
                  break;
              }
              if (match) {
                totalRx += item.rx || 0;
                totalTx += item.tx || 0;
              }
              return match;
            });
            this.currentStats = {
              rx: totalRx,
              tx: totalTx,
              total: totalRx + totalTx,
            };
            const getXValue = (date, time) =>
              this.getXValue(date, time, dataType);
            return [
              this.generateSeries("ä¸Šè¡Œ", "tx", this.theme.upload, getXValue),
              this.generateSeries("ä¸‹è¡Œ", "rx", this.theme.download, getXValue),
            ];
          },
          processCurrentData(currentDate, dataType) {},
          //è·å–å¤‡ä»½æ•°æ®ï¼ˆå¸¦ç¼“å­˜ï¼‰
          async getBackupData(dateStr) {
            // åˆå§‹åŒ– backupCache ä¸º Mapï¼ˆè‹¥å°šæœªåˆå§‹åŒ–ï¼‰
            if (!(this.backupCache instanceof Map)) {
              this.backupCache = new Map();
            }
            //å…ˆæ£€æŸ¥å†…å­˜ç¼“å­˜
            if (this.backupCache[dateStr]) {
              return this.backupCache[dateStr];
            }
            //å†æ£€æŸ¥localStorage
            const cachedData = localStorage.getItem(`backup_data`);
            if (cachedData) {
              this.backupCache = JSON.parse(cachedData);
              if (this.backupCache[dateStr]) {
                return this.backupCache[dateStr];
              }
            }
            try {
              const url = `${this.url.backups}${dateStr}`;
              const response = await this.fetchWithAuth(url);
              const data = await response.json();
              if (data && !data.error) {
                // æ’å…¥æ–°æ•°æ®
                this.backupCache[dateStr] = data;
                this.cacheKeys.push(dateStr);
                // å¦‚æœé•¿åº¦è¶…è¿‡5ï¼Œåˆ é™¤æœ€æ—§çš„é”®
                if (this.cacheKeys.length > 5) {
                  const oldestKey = this.cacheKeys.shift();
                  delete this.backupCache[oldestKey];
                }
                localStorage.setItem(
                  `backup_data`,
                  JSON.stringify(this.backupCache)
                );
                return data;
              } else {
                return null;
              }
            } catch (e) {
              console.error("å¤‡ä»½æ•°æ®è·å–å¤±è´¥:", e);
              return null;
            }
          },
          //å¤„ç†å¤‡ä»½æ•°æ®
          processBackupData(currentDate, backupData, dataType) {
            const selectedInterfaceData = backupData.interfaces.find(
              (item) => item.name === this.latestSelectedInterfaceData.name
            );
            // ç­›é€‰é€»è¾‘ï¼ˆç¤ºä¾‹å¤„ç†å°æ—¶ç²’åº¦ï¼‰
            const rawData = selectedInterfaceData.traffic[dataType] || [];
            return this.processData(currentDate, rawData, dataType);
          },
          generateSeries(name, field, color, getX) {
            return {
              name,
              data: this.filteredData.map((d) => ({
                x: getX(d.date, d.time),
                y: d[field] / (1024 * 1024), // ç»Ÿä¸€å•ä½è½¬æ¢
              })),
              color,
            };
          },
          getXValue(date, time, dataKey) {
            const itemYear = date.year;
            const itemMonth = String(date.month).padStart(2, "0");
            const itemDay = String(date.day).padStart(2, "0");
            var itemHour = "";
            var itemMinute = "";
            if (time) {
              itemHour = String(time.hour).padStart(2, "0");
              itemMinute = String(time.minute).padStart(2, "0");
            }
            switch (dataKey) {
              case "fiveminute":
                return `${itemYear}-${itemMonth}-${itemDay} ${itemHour}:${itemMinute}`;
              case "hour":
                return `${itemYear}-${itemMonth}-${itemDay} ${itemHour}æ—¶`;
              case "day":
                return `${itemYear}-${itemMonth}-${itemDay}`;
              case "month":
                return `${itemYear}-${itemMonth}`;
            }
          },
          async updateChart() {
            const seriesData = await this.getMergedSeriesData();

            const options = {
              chart: { type: "area", height: 400 },
              series: seriesData,
              fill: {
                type: "solid",
              },
              dataLabels: {
                enabled: false,
              },
              stroke: {
                curve: "smooth",
                width: 2,
              },
              markers: {
                size: 3,
                hover: { size: 5 },
              },
              xaxis: {
                type: "category",
                title: { text: this.getXAxisTitle() },
              },
              yaxis: {
                title: { text: "æµé‡ (MB)" },
                labels: {
                  formatter: function (value) {
                    return value % 1 === 0
                      ? value.toFixed(0) // æ•´æ•°æ˜¾ç¤º
                      : value.toFixed(2); // å°æ•°ä¿ç•™ä¸¤ä½
                  },
                },
              },
              tooltip: {
                y: {
                  formatter: (value) => {
                    const formatResult = this.formatFromMB(value);
                    return formatResult.value + formatResult.unit;
                  },
                },
              },
            };
            if (this.chart) {
              this.chart.updateOptions(options);
            } else {
              this.chart = new ApexCharts(
                document.querySelector("#trafficChart"),
                options
              );
              this.chart.render();
            }
          },
          formatFromMB(mb) {
            const units = ["MB", "GB", "TB"];
            let value = Number(mb);
            let i = 0;
            while (value >= 1024 && i < units.length - 1) {
              value /= 1024;
              i++;
            }
            return {
              value: value.toFixed(2),
              unit: units[i],
            };
          },
          getformatTableTime(date, time) {
            const dataType = {
              hour: "fiveminute",
              day: "hour",
              month: "day",
              year: "month",
            }[this.timeRangeType];
            return this.getXValue(date, time, dataType);
          },
          getXAxisTitle() {
            return {
              day: "å°æ—¶",
              month: "æ—¥æœŸ",
              year: "æœˆä»½",
            }[this.timeRangeType];
          },
          formatTime(timeObj) {
            if (!timeObj?.timestamp) return "N/A";
            const date = this.getBeijingTime(timeObj.timestamp);
            return `${date.getUTCFullYear()}-${this.pad(
              date.getUTCMonth() + 1
            )}-${this.pad(date.getUTCDate())}
                ${this.pad(date.getUTCHours())}:${this.pad(
              date.getUTCMinutes()
            )}`;
          },
          // è¡¥é›¶å‡½æ•°
          pad(num) {
            return num.toString().padStart(2, "0");
          },
          getBeijingTime(timestamp) {
            const date = new Date(timestamp * 1000);
            date.setMinutes(date.getMinutes() + date.getTimezoneOffset() + 480); // UTC+8
            return date;
          },
          saveThemeColors() {
            document.documentElement.style.setProperty(
              "--accent-color",
              this.theme.accent
            );
            document.documentElement.style.setProperty(
              "--main-color",
              this.theme.main
            );
            document.documentElement.style.setProperty(
              "--contrast-color",
              this.theme.contrast
            );
          },
          loadThemeColors() {
            const savedColors = localStorage.getItem("themeColors");
            if (savedColors) {
              const theme = JSON.parse(savedColors);
              if (theme.name == "è‡ªå®šä¹‰") {
                this.presetThemes.push(theme);
              }
              this.theme = theme;
              this.saveThemeColors();
              localStorage.setItem("themeColors", JSON.stringify(this.theme));
            }
            localStorage.setItem("themeColors", JSON.stringify(this.theme));
          },
          isLateNight() {
            const currentHour = new Date().getHours();
            return currentHour >= 23 || currentHour < 6;
          },
          showMessage(msg) {
            const container =
              document.querySelector(".msg-container") ||
              this.createContainer();
            const msgEl = document.createElement("div");
            msgEl.className = "message";
            msgEl.textContent = msg;
            container.appendChild(msgEl);
            setTimeout(() => msgEl.classList.add("show"), 10);
            setTimeout(() => {
              msgEl.classList.remove("show");
              setTimeout(() => msgEl.remove(), 300);
            }, 3000);
          },
          createContainer() {
            const container = document.createElement("div");
            container.className = "msg-container";
            document.body.appendChild(container);
            return container;
          },
        },
        async mounted() {
          if (this.isLateNight()) {
            this.toggleNightMode(1);
            this.showMessage("å¤œæ·±äº†ï¼Œå·²åˆ‡æ¢æˆå¤œé—´æ¨¡å¼");
          }
          this.loadThemeColors();
          // åˆå§‹åŒ–æ—¶æ£€æŸ¥æœ¬åœ°Token
          const storedToken = localStorage.getItem("jwt_token");
          // åˆå§‹åŒ–æ£€æŸ¥ç¼“å­˜apié€‰é¡¹
          const assistApi = localStorage.getItem("assist_api");
          const savedEnable = localStorage.getItem("enable_backup");
          this.enableBackupData =
            savedEnable !== null ? savedEnable === "true" : true;
          if (!this.enableBackupData) {
            localStorage.removeItem("backup_data");
          }
          if (assistApi) {
            this.assistApi = assistApi;
            this.url = {
              login: this.assistApi + "/auth/login",
              verify: this.assistApi + "/auth/verify",
              loadJson: this.assistApi + "/json.cgi",
              backups: this.assistApi + "/backups/",
            };
          }
          if (!this.assistApi) {
            alert("è¯·å…ˆç‚¹å‡»å³ä¸Šè§’è®¾ç½®ç»Ÿä¸€APIå…¥å£");
            this.handleLogout();
            return;
          }
          if (storedToken) {
            // éªŒè¯Tokenæœ‰æ•ˆæ€§
            this.authToken = storedToken;
            const response = await this.fetchWithAuth(this.url.verify);
            if (response.ok) {
              this.handleAuthSuccess(storedToken);
            } else {
              this.handleLogout();
            }
          } else {
            this.handleLogout();
          }
        },
      });
    </script>
  </body>
</html>
